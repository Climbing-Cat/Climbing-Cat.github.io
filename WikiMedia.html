<!--
https://softwareengineeringdaily.com/tag/indie-hackers/
http://stackoverflow.com/questions/7605930/how-to-set-start-time-offset-using-setcurrenttime
https://github.com/johndyer/mediaelement/blob/master/docs/api.md
https://designmodo.com/audio-player/
http://butlerccwebdev.net/support/html5-video/mediaelementjs-demo.html
http://folk.uib.no/jvi041/player/examples/_name=loop.html

Time-based events in MediaElements.js
https://github.com/johndyer/mediaelement/issues/707
http://stackoverflow.com/questions/36453069/how-to-add-pause-points-to-mediaelement-js-video-player

local files:
		<script src="js/jquery.js"></script>
		<script src="js/mediaelement-and-player.min.js"></script>
		<link href="css/mediaelementplayer.min.css" rel="stylesheet" />

		online files:
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/mediaelement/latest/mediaelement-and-player.min.js"></script>
		<link href="https://cdn.jsdelivr.net/mediaelement/latest/mediaelementplayer.css" rel="stylesheet" />

Sample URL's
____________
Training Beta (Uses libsyn)
https://traffic.libsyn.com/secure/force-cdn/highwinds/trainingbeta/Danny-Robertson.mp3
http://traffic.libsyn.com/forcedn/trainingbeta/Madaleine-Sorkin.mp3

The Enormocast (Uses blubrry, download link in page)
http://media.blubrry.com/enormocast/p/content.blubrry.com/enormocast/Enormo115PaulRobinson.mp3

Training For Climbing (Uses libsyn. Page has basic time-stamped notes)
http://trainingforclimbing.com/podcast-12-the-10-4-rule-for-effective-projecting-steady-improvement/
search for iframe, then search for:
		var mediaURLLibsyn = "http://traffic.libsyn.com/force-cdn/ec/trainingforclimbing/podcast_12_May2017_The_10-4_Rule_Projecting.mp3";
		var mediaURL = "http://traffic.libsyn.com/force-cdn/ec/trainingforclimbing/podcast_12_May2017_The_10-4_Rule_Projecting.mp3";

http://traffic.libsyn.com/force-cdn/ec/trainingforclimbing/podcast_12_May2017_The_10-4_Rule_Projecting.mp3

The Dirtbag Diaries (uses SoundCloud, not sure how to Extract yet!)
 - search for an iframe with text player
src url will be: http://w.soundcloud.com/player/?url=https%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F319939267&visual=true&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false
the url needs to be URL decoded to: https://api.soundcloud.com/tracks/319939267
then append: /download?client_id=a3e059563d7fd3372b49b37f00a00bcf
OR load the iframe src and search for "download_url":"https://api.soundcloud.com/tracks/319939267/download
then append the correct client_id for the site: ?client_id=a3e059563d7fd3372b49b37f00a00bcf

http://dirtbagdiaries.com/the-bet/
https://api.soundcloud.com/tracks/319939267/download?client_id=a3e059563d7fd3372b49b37f00a00bcf

http://dirtbagdiaries.com/shorts-catching-hope/
https://api.soundcloud.com/tracks/317557821/download?client_id=a3e059563d7fd3372b49b37f00a00bcf

Chalk Talk (CTClimbing Podcast, Uses libsyn, There's a small play button at the bottom of the page. Page contains basic notes)
http://ctclimbingpodcast.com/louieanderson/
http://hwcdn.libsyn.com/p/5/6/a/56a372124be74d07/Ep.7_-_Louie_Anderson.mp3?c_id=7568960&expiration=1493839434&hwt=99520384c73b5174a0512dad57c46be0

Try this! Download from SoundCloud:
http://lifehacker.com/5891635/download-any-mp3-from-soundcloud-with-this-bookmarklet

client_id query string parameter seems to be per site/customer)? - which is why it works for 2 different mp3 urls?

The Power Company Podcast (uses PodBean)
https://powercompanyclimbing.podbean.com/page/1/
search for: data-uri="http://powercompanyclimbing.podbean.com/mf/play/hihu7h/Episode_92_Health_Starts_in_the_Gut_with_Aicacia_Young.mp3" 
change to:           https://powercompanyclimbing.podbean.com/mf/download/hihu7h/Episode_92_Health_Starts_in_the_Gut_with_Aicacia_Young.mp3


The Ledge - A Climbing Life Podcast (uses SoundCloud)
www.theledge.se/podcasts

Jam Crack - The Niall Grimes Climbing Podcast (Uses libsyn)
www.niallgrimes.com/jam-crack-podcast/

The Bad Beta Podcast (Uses libsyn)
http://www.badbetapodcast.com

The Sharp End (uses SoundCloud, seems like a mountaineering podcast)
https://m.soundcloud.com/the_sharp_end

MtnMeister (uses SoundCloud, outdoors podcasts covering climbing, skiing, mountaineering, ultrarunning etc.)
https://player.fm/series/mtnmeister-48469
mtnmeister.com

Ideas for playlist
https://css-tricks.com/draggable-elements-push-others-way/

http://code.makery.ch/library/dart-drag-and-drop/

http://touchpunch.furf.com/

jQuery UI sortables drag to trash - JSFiddle
https://jsfiddle.net/Glutnix/pSgDu/


jquery toggle switch:
https://github.com/timmywil/jquery.onoff
http://proto.io/freebies/onoff/

-->

<html>

	<head>
		<title>WiKiMedia Player</title>

		<link  href="https://refreshless.com/nouislider/distribute/nouislider.min.css?v=1440" rel="stylesheet"/>
		<link rel="stylesheet" href="css/nouislider.mod.css"/>

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		
		<link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/blitzer/jquery-ui.min.css" rel="stylesheet" />
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

	
		<script src="https://refreshless.com/nouislider/distribute/nouislider.min.js?v=1440"></script>

		<link  href="https://cdn.jsdelivr.net/npm/round-slider@1.5.1/dist/roundslider.min.css" rel="stylesheet"/>
		<link  href="css/roundslider.mod.css" rel="stylesheet"/>

		<script src="https://cdn.jsdelivr.net/npm/round-slider@1.5.1/dist/roundslider.min.js"></script>
	
		<link  href="css/mediaelementplayer.min.css" rel="stylesheet" />	
		<script src="js/mediaelement-and-player.min.js"></script>
		<script src="js/mediaelement/renderers/vimeo.js"></script>


		<!-- common -->
		<link  href="css/audio-video-switch.onoff.css" rel="stylesheet"/>
		<link  href="css/play-edit-switch.onoff.css" rel="stylesheet"/>
		<script src="js/jquery.onoff.js"></script>
		<script src="js/controls1.js"></script>

		<link type="text/css" href="css/playlist-container.css" rel="stylesheet" />
		<script src="js/Sortable.js"></script>
		<script src="js/playlist.js"></script>
		<script src="js/json-url.js"></script>


		<script>
			if (window.location.protocol == "file:") {

				window.fetcher = function(url, elementName) {
						const req = new XMLHttpRequest();    
						req.onload = () => {
							 document.querySelector(elementName).innerHTML = req.responseText;
						};
						req.onerror = () => {
							console.log("error. start chrome from CLI: chrome.exe  -incognito --allow-file-access-from-files");
						};						
						req.open('GET', url);
						req.send();
					};
			}
			else{
				window.fetcher = function(url, elementName) {
						fetch("table.html")
						.then(response => {
							return response.text()
						})
						.then(data => {
							document.querySelector(elementName).innerHTML = data;
						});
					};
			}
		</script>


		<style type="text/css">

			#add_theme_dialog label, #add_theme_dialog input { display:block; }
			#add_theme_dialog label { margin-top: 0.5em; }
			#add_theme_dialog input, #add_theme_dialog textarea { width: 95%; }
			#add_theme_tab { cursor: pointer; }

			/*.playlist { list-style-type: none; margin: 0; padding: 0;  }*/




			/* non playing items */
			.list-group-item,
			.chosen-item,
			.drag-item,
			.ghost-item
			{ color: black; background-color: white; }	/* finalised playlist items */

			.onTheFly,
			.onTheFly.chosen-item,
			.onTheFly.drag-item,
			.onTheFly.ghost-item
			{ color: black; background-color: white; }	/* OTF playlist items */

			.onTheFly .PoCaRangeOTF					/* 'Finalise' */
			{
				display: inline-block;
				float: right;
				margin: 0px;
				margin-right: 30px;
				padding: 0px;
				text-align: center;
				color: #39E884;
				background-color: transparent;
			}


			/* currently playing items */
			.currentlyPlaying,
			.currentlyPlaying.chosen-item,
			.currentlyPlaying.drag-item,
			.currentlyPlaying.ghost-item
			{background-color: #39E884 !important;}		/* finalised playlist items */
			
			.onTheFly.currentlyPlaying,
			.onTheFly.currentlyPlaying.chosen-item,
			.onTheFly.currentlyPlaying.drag-item,
			.onTheFly.currentlyPlaying.ghost-item
			{background-color: #79daff !important;}		/* OTF playlist items */

			.onTheFly.currentlyPlaying .PoCaRangeOTF/* 'Finalise' */
			{
				display: inline-block;
				float: right;
				margin: 0px;
				margin-right: 30px;
				padding: 0px;
				text-align: center;
				color: #00ac4a;
				background-color: #79daff;
			}

			
			#slider-handle {
				min-width: 1em;
				width: auto;
				height: 1.6em;
				top: 50%;
				margin-top: -.8em;
				text-align: center;
				line-height: 1.6em;
				font-size: 0.75em;
			}
			
			.disabledText {
			   color: darkgrey;
			}



			/* https://www.arungudelli.com/tutorial/css/disable-text-selection-in-html-using-user-select-css-property/ */
			.disable-text-select {
				user-select: none; /* supported by Chrome and Opera */
				-webkit-user-select: none; /* Safari */
				-khtml-user-select: none; /* Konqueror HTML */
				-moz-user-select: none;  /* Firefox */
				-ms-user-select: none;  /* Internet Explorer/Edge */
			}

			/* CSS hide scroll bar, but have element scrollable */
			/* https://stackoverflow.com/questions/43186015/css-hide-scroll-bar-but-have-element-scrollable/43186311 */
			.hide-scrollbar::-webkit-scrollbar {
				width: 0px;
				height: 0px;
				background: transparent; /* make scrollbar transparent */
			}
		</style>
	</head>

	<body>

		<div style="width: 100%; height: 30px;">
		<div style="text-align: center;">
			<div style="display: inline-block;">
				<h1>WiKiMedia Player</h1>
				<h5 style="text-align:right;"><i>by Climbing-Cat</i></h5>
			</div>
			</div>
			</br>

			<div id="MediaModePanel">
				<div class="onoffswitch" style="display: inline-block;">
					<input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="MediaType" >
					<label class="onoffswitch-label" for="MediaType">
						<span class="onoffswitch-inner"></span>
						<span class="onoffswitch-switch"></span>
					</label>
				</div>
				&nbsp;&nbsp;
				<input type="button" id="start" style="position:relative; display: inline-block; top: -10px; height:30px; line-height: 26px; font-size: 14px;" value="Start"></input>
			</div>
			
<div id="MediaPanel" style="display: none;">
			<div class="playEditSwitch">
				<input type="checkbox" name="playEditSwitch" class="playEditSwitch-checkbox" id="PoCaMode" checked>
				<label class="playEditSwitch-label" for="PoCaMode">
					<span class="playEditSwitch-inner"></span>
					<span class="playEditSwitch-switch"></span>
				</label>
			</div>
			</br>
			</br>

			<div id="podcastPresets">
			</div>
			<script>
				window.fetcher("table.html", "#podcastPresets");
			</script>
  
			<input id="urlInput" type="text" name="urlInput" value="" size="75">
			<a href="#" id="setUrl" > Load URL</a>

			
			<!-- a href="#" id="searchPodcasts" onclick=""> searchPodcasts</a -->

			<div id="audio-player-div" class="editcontrols"></div>
			<div id="video-player-div" class="editcontrols"></div>

			<div id="controls" style="display: none">
				<div id="nusDiv" class="editcontrols">
					<div id="noUiSlider"></div>
				</div>
				
				<div id="dial1box" class="box editcontrols" style="display: inline-block; position: relative; text-align: center;">
					<div id="dial1" class="dial"></div></br>
					<a href="#" id="setDial1">set Dial</a>
				</div>
				
				<div id="dial2box" class="box editcontrols" style="display: inline-block; position: relative; text-align: center;">
					<div id="dial2" class="dial"></div></br>
					<a href="#" id="lockDial2" style="display:none;">lock Dial</a>
					<a href="#" id="setDial2">set Dial</a>
				</div>
			</div>
			</br></br></br>
			
			<div id="delayDiv" style="display:none;">
				Pause: <input id="inputPoCaDelay" type="text" name="delay" value="0" class="editcontrols"> (s)
				</br>
			</div>


			<div id ="createButtonsDiv" class="editcontrols" style="display:none;">
				<button id="createPoCaMark" style="display:none;">Create Media Mark</button>
				<div id="createPoCaRange" style="border-radius: 6px; background-color: #b0efb1; color: #005000; text-align: center; width: 175px; display:inline-block;">
					<b>Create Snippet <br> from markers</b>
				</div>
				<div id="multi-click" style="border-radius: 6px; background-color: #d71919; color: white; text-align: center; width: 175px; display:inline-block; position:relative;" >
					<b>Create Snippet </br> On The Fly</b>
				</div>
			</div>

			</br>
			
			<div style="width: 600px; border-style: none;">
				Snippet Title:</br>
				<input id="inputPoCaTitle" type="text" style="width: 100%;" name="title" value="" class="editcontrols"></br>
				Snippet Note:</br>
				<textarea id="inputPoCaNotes" style="width: 100%; resize: none;" rows="6" class="editcontrols"></textarea></br>

			</div>

			</br>
			<hr>

			<div id="playlistContainer" style="display: none;" class="playlistDropArea">
				<div id="add_theme_dialog" title="Theme Name">
					<form>
						<fieldset class="ui-helper-reset">
							<input type="text" name="tab_title" id="tab_title" value="" maxlength="20" class="ui-widget-content ui-corner-all" />
						</fieldset>
					</form>
				</div>
				<button id="add_theme_tab">Add Theme</button>
				<div id="tabsPanel">
					<div id="tab" class="tab tab-group  hide-scrollbar" style="overflow-x: scroll;">
						<button id="tabs-1-button" class="tablinks" data-tabname="tabs-1">
							<span class="tablabel">Main</span>
							<span class="tablinkicon ui-icon ui-icon-closethick"></span>
						</button>
					</div>
					<div id="tabcontents">
						<div id="tabs-1" class="tabcontent disable-text-select" style="display:block;">
							<ul id="playlist-1" class="list-group  hide-scrollbar playlist active-playlist playlistEditable" style="height: 200px; overflow-y: scroll;">
								<li class="list-group-item">
									<span class="ui-icon ui-icon-closethick"></span>
									<i class="fa fa-arrows grabbable" aria-hidden="true">&nbsp;&nbsp;&nbsp;</i>
									Chisel
								</li>
							</ul>		
						</div>
					</div>
					<div class="clearfix"></div>
				</div>

				</br>
				<div id="slider" style="margin-left:2.4em; margin-right:2.4em;">
					<div id="slider-handle" class="ui-slider-handle"></div>
				</div>

				</br>

				<hr>

			</div>
</div>
<div style="display: none;">
			<p><a id="expandAdvanced" href="#"><span>+</span>  Dev tools/options/info</a>
			<div id="contentAdvanced" style="display:none; width: 600px; border-style: none;">
				<input id="timeInput" type="text" name="time" value="400">
				<a href="#" class="bm3" >Go to time (in seconds)</a>
				</br>

				<input id="timeOutput" type="text" name="time" value=""> (s)
				<input id="timeOutput2" type="text" name="time" value=""> (hh:mm:ss)
				<a href="#" class="cbm" >Get current elapsed time (in seconds)</a>
				</br>
				</br>

				Snippet Data to Save:</br>
				<textarea id="inputPoCaDataToSave" style="width: 100%; resize: none;" rows="12" readonly></textarea>
			</div>
</div>
			<p><a id="expandFileOptions" href="#"><span>+</span> Import Export Media Snippets File</a>
			<div id="contentFileOptions" style="display: none;">
				<table>
					<tr id="loadOption">
						<td>Select a Media Snippets File to Load:</td>
						<td><input type="file" id="fileToLoad"></td>
						<td><button id="loadPoCaDataBtn">Import </button><td>
					</tr>
				</table>
				<div>
					</br>
					<button id = "savePoCaDataBtn">Export URL</button>
					</br>
					<div>
						<input type="checkbox" id="exportToFileCheckBox" />
						<label id="filenameToSaveAs" class="disabledText">Filename to Save As:<input id="inputFileNameToSaveAs" disabled/></label>
					</div>
					</br>
					<div id="exportedURL" style="display:none; width: 600px; border-style: none;">
						<!-- textarea id="exportPoCaDataToSaveBase64" style="width: 100%; resize: none;" rows="12" readonly></textarea -->

						<form id="tinyURLForm" action="https://tinyurl.com/create.php" method="post" >
							<table style="width: 600px;" align="center" cellpadding="5" bgcolor="#E7E7F7"><tr ><td >
							<b>Exported URL:  </b><br/>
							<input type="text" name="url" id="inputTinyURL" size="68"><input type="submit" name="submit" value="Create a tinyURL"/>
							</td></tr></table>
						</form>

					</div>
				</div>
			</div>
		</br>
		</br>
		</br>
		</br>

		</div>

		<script>

		//start of theme tabs panel functionality
		/*
			Theme (context) objects will be stored in theme map themeID->themeObject
			On page load, default theme (main) object will need to be created
			On PoCa file load, all current themes cleared and new ones created from data file
			Theme tabs and separate playlist divs created
			On PoCa file save, inputPoCaDataToSave textarea is first cleared and filled with; theme info followed by collated PoCaMarks (from all themes) - ordered by UI theme tabs
			inputPoCaDataToSave textarea can also be populated with common functionality from export func using a refresh button? - so, it's not done for every little text change!

			Theme object variables needed to maintain/switch context:
			themeId
			theme name
			currentplaylistID
			currentPoCaMarkIndex
			playlistMap
			PoCaMarks

			_____________________________
			
			when switching context (theme):
			1. stop playback
			2. ? global playlistItemSelected will need to be set to false AND run the logic associated with setting to false ?
			2. backup global variables to current context object
			3. copy next context variables to global scope
			
		*/
			var playlistID = 0; //global - across themes
			var playlistMap = new Map();
			var currentplaylistID = 0;


			var paused = true;


			$(document).ready(function() {

				//fixes same page links on github pages. Maybe base ref is not set correctly?
				//regardless, clicking a link now does nothing instead of going to the top of the page
				$('a[href="#"]').prop('href','javascript:void(0);');

				$("#MediaType").onoff();
				//$("#PoCaMode").onoff(); //doesn;t seem to work, calling onoff once is enough?

/*
							$("#PoCaMode").onoff('disable');
							$("#PoCaMode").prop("disabled", true);

							$("#PoCaMode").onoff('enable');
							$("#PoCaMode").prop("disabled", false);

							var disabled = $("#PoCaMode").onoff('isDisabled');
							console.log("PoCaMode off: "+disabled);
*/

				//also see: https://dtbaker.net/blog/submit-a-form-into-a-popup/
				$('#tinyURLForm').submit(function() {
					let newWindow = window.open('', 'formpopup', 'width=400,height=400,resizeable,scrollbars, status=no,location=no,toolbar=no, left=100, top=300');
					this.target = 'formpopup';
				});

				InitialiseSortableTabs("tab", ".tab-group");


//tabs
var tabTitle = $( "#tab_title" );
var tabTitleSanitized = "";
var tabTemplate = "<button id='#{href}-button' class='tablinks tab-group-item' data-tabname='#{href}'><span class='tablabel'>#{label}</span></button>";

const  maxTabs = 5;


function doesThemeAlreadyExist()
{
	var newLabel = tabTitle.val();
	newLabel = newLabel.replace("&nbsp;", " ").replace("&#9;", " ")
					   .replace("&nbsp", " ").replace("&#9", " ").trim();
	tabTitleSanitized = newLabel;
	if (newLabel.length == 0 || newLabel.includes("\\") || newLabel.includes("&")) return true;

	return ($("#tab .tablinks .tablabel").filter(
		function() {
			return $(this).text() == newLabel;
		})
		.length > 0);
}

// modal dialog init: custom buttons and a "close" callback resetting the form inside
var dialog = $( "#add_theme_dialog" ).dialog({
	autoOpen: false,
	modal: true,
	buttons: {
		Add: function() {
			if (!doesThemeAlreadyExist())
			{
				addTab();
				$( this ).dialog( "close" );
			}
		},
		Cancel: function() {
			$( this ).dialog( "close" );
		}
	},
	close: function() {
		form[ 0 ].reset();
	}
});


// addTab form: calls addTab function on submit and closes the dialog
var form = dialog.find( "form" ).submit(function( event ) {

	if (!doesThemeAlreadyExist())
	{
		addTab();
		dialog.dialog( "close" );
	}
	event.preventDefault();
});

function hideAddButtonThemeWhenMaxReached()
{
	if (themeMap.size >= maxTabs) //>= instead of ==, incase loading from file - which can be tampered with/or legacy file?
	{
		$( "#add_theme_tab" ).hide();
	}
}

function findNextFreeThemeId()
{
	if (themeMap.size >= maxTabs)
	{
		console.log("Max Themes reached! No free themeId available.");
		return null;
	}
	
	for(var nextThemeId = 1; nextThemeId <= maxTabs; ++nextThemeId)
	{
		if (!themeMap.has(nextThemeId.toString()))
		{
			console.log("nextFreeThemeId: "+ nextThemeId);
			return nextThemeId.toString();
		}
	}

	console.log("No free themeId available!");
	return null;
}

// actual addTab function: adds new tab using the input from the form
function addTab() {
	var themeId = findNextFreeThemeId();
	var label = tabTitleSanitized || "Tab " + themeId;
	//var theme = new PoCaTheme(themeId, label); //can't directly create this otherwise unnecessary fields get outputted on export, don't know why yet!!!
	var src = '{"Id":"' + themeId + '","name":"' + label + '"}'
	var PoCaThemeTemp = JSON.parse(src);
	var theme = new PoCaTheme.FromObject(PoCaThemeTemp);
	
	addTheme(theme);
}

function addTheme(theme) {
	var themeId = theme.Id.toString();
	var label = theme.name;

	var id = "tabs-" + themeId;
	var li = $( tabTemplate.replace( /#\{href\}/g, id ).replace( /#\{label\}/g, label ) );


	$("#tab").append( li );
	$("#tabsPanel #tabcontents").append( "<div id='" + id + "' themeId='" + themeId + "'  class='tabcontent disable-text-select'>" +
	"<ul id='playlist-" + themeId + "' style='max-height: " + playlistPxHeight + "px; overflow-y: scroll;' class='list-group hide-scrollbar playlist playlistEditable'></ul>" +
	"</div>" );
	
	
	//style="height: 200px; overflow-y: scroll;">height or max height?


	themeMap.set(themeId.toString(), theme);

	if (themeMap.size > 1) { //more than 1 tab button on screen. find the tab button w/o close icon and add one (it will be the first tab that was added)
		$("#tab .tablinks:not(:has(.ui-icon-closethick))").append("<span class='tablinkicon ui-icon ui-icon-closethick'></span>");
	}
	
	InitialiseSortablePlaylist(id, ".playlist");
	
	hideAddButtonThemeWhenMaxReached();
}

// addTab button: opens the dialog
$( "#add_theme_tab" ).button().click(function() {
		dialog.dialog( "open" );
});


function switchContextOnDeleteTab(themeId) //switch context to first theme that isn't the currently deleting theme
{
	var mapKeys = themeMap.keys();
	var nextThemeId = mapKeys.next().value;
	if (nextThemeId == themeId)
	{
		nextThemeId = mapKeys.next().value;
	}
	console.log("nextThemeId: "+ nextThemeId);

	$("#tabs-" + nextThemeId + "-button").click();
}


function removeTabAllowed()
{
	if ($("#tab .tablinks").length == 1)
	{
		return false;
	}
	
	return true;
}

function afterRemoveTab(themeId)
{
	themeMap.delete(themeId);
	console.log("removed theme (Id=" + themeId + ") from themeMap");

	if (themeMap.size == 1)
	{
		$( "#tab .tablinks .ui-icon-closethick" ).remove();
	}

	if (themeMap.size < maxTabs)
	{
		$( "#add_theme_tab" ).show();
	}
}

// Remove the tab on close icon click
$("#tab").on("click touchstart", ".tablinks .ui-icon-closethick", function(e) {
	if (!removeTabAllowed())
	{
		return;
	}

	var panelId = $( this ).parent().remove().data("tabname");
	var panel = $( "#" + panelId );
	var themeId = panel.attr('themeid');
	$( "#" + panelId ).remove();

	if (themeId == currentThemeID) //closing a tab via x-icon - tab might be active/current (theme context might be current, so switch it if this is the case)
	{
		//switch context to first theme that isn't the currently deleting theme
		switchContextOnDeleteTab(themeId);
	}

	afterRemoveTab(themeId);

	e.stopPropagation(); //stops the bubbling of an event to parent elements. (Prevents li selection)
});


function resetTabsOnLoad()
{
	DestroyAllSortablePlaylists();
	$("#tab .tablinks").remove();
	$("#tabspanel #tabcontents .tabcontent").remove();
	themeMap.clear();
}


//end of theme tabs panel functionality

//_______________________________________________________________________________________________________________
//_______________________________________________________________________________________________________________

		
				if (!Date.now) {
					Date.now = function() { return new Date().getTime(); }
				}

				function get_style_rule_value(selector, style)
				{
					var selector_compare=selector.toLowerCase();
					var selector_compare2= selector_compare.substr(0,1)==='.' ?  selector_compare.substr(1) : '.'+selector_compare;

					for (var i = 0; i < document.styleSheets.length; i++)
					{
						var mysheet = document.styleSheets[i];

						try
						{
							var myrules = mysheet.cssRules ? mysheet.cssRules : mysheet.rules;

							for (var j = 0; j < myrules.length; j++)
							{
								if (myrules[j].selectorText)
								{
									var check = myrules[j].selectorText.toLowerCase();
									switch (check)
									{
										case selector_compare  :
										case selector_compare2 : return myrules[j].style[style];
									}
								}
							}
						} //try
						catch(err)
						{}
					} //for
				} //func
	 
				function get_style_rule_Int_value(selector, style)
				{
					var temp = get_style_rule_value(selector, style);
					
					return parseInt(temp, 10);
				}

				//set playlist height
				var paddingTop = get_style_rule_Int_value('.playlist li', 'padding-top');
				var paddingBottom = get_style_rule_Int_value('.playlist li', 'padding-bottom');
				var height = get_style_rule_Int_value('.playlist li', 'height');
				var marginTop = get_style_rule_Int_value('.playlist li', 'margin-top');
				var marginBottom = get_style_rule_Int_value('.playlist li', 'margin-bottom');
				var playlistItemPxHeight = marginTop + paddingTop + height + paddingBottom + marginBottom;
				var playlistItemsToDisplay = 5;
				var playlistPxHeight = playlistItemPxHeight * playlistItemsToDisplay;
				/*
				console.log("paddingTop: " + paddingTop);
				console.log("paddingBottom: " + paddingBottom);
				console.log("height: " + height);
				console.log("marginTop: " + marginTop);
				console.log("marginBottom: " + marginBottom);
				*/
				//console.log("playlistItemPxHeight: " + playlistItemPxHeight);
				//console.log("playlistItemsToDisplay: " + playlistItemsToDisplay);
				//console.log("playlistPxHeight:" + playlistPxHeight);

				playlistPxHeight -= marginBottom;
 				$(".playlist").attr('style', "max-height: " + playlistPxHeight + "px; overflow-y: auto;");

				/*

				var lastScroll = 0;
				var count = 1;
				
				var lastScrollTime = Date.now();

				$('.active-playlist').scroll(function(){
				
					var curScrollTime = Date.now();
					
					if (curScrollTime < lastScrollTime + 1000)
					{
						console.log("tooearly");
						return;
					}
					lastScrollTime = curScrollTime;
					
					
					var el = $(this);
					var scroll = el.scrollTop();
				console.log("scroll: " + scroll);
				console.log("lastScroll: " + lastScroll);
var scrollableHeight = (PoCaMarks.length * playlistItemPxHeight) - playlistPxHeight;
				//console.log("scrollableHeight: " + scrollableHeight);
				//console.log("percentage: " + (scroll / scrollableHeight) * 100);


				//console.log("lastScroll: " + lastScroll);
					var round;
					
					if (lastScroll < scroll)
					{
						round = Math.ceil;
						count ++;
					}
					else
					{
						count --;
						round = Math.floor;
					}

				//console.log("round: " + round + " = " + round(scroll/16));
					lastScroll = round(scroll/16) * 16;
					//el.scrollTop(lastScroll);
					
				//console.log("");
					var container = $(this);
					var nthChildStr = ":nth-child(" + count + ")";
					var scrollTo = $('.active-playlist li' + nthChildStr);

					lastScroll = scrollTo.offset().top - container.offset().top + container.scrollTop();
					container.animate({
					    scrollTop: lastScroll
					});

					count++;
					console.log(count);

				});
*/

				$("#playlistContainer").show();


/*
				//set input field to default mp3 shown in combobox
				//then load the player with that mp3
				var selectedSite = $("#PodcastSite").find('option:selected').index();
				var mp3Url = document.getElementById("Site" + selectedSite + "Podcasts").value
				$("#urlInput")[0].value = mp3Url;
*/
				function createAudioPlayer()
				{
					var mp3Url = "";
					$("#audio-player-div").empty();
					document.getElementById('audio-player-div').innerHTML = '';
					document.getElementById('video-player-div').innerHTML = '';
					//<audio name="audio-player" id="audio-player" src="" type="audio/mp3" controls="controls"></audio>
					document.getElementById('audio-player-div').innerHTML += '<audio id="player" name="audio-player" src="' + mp3Url + '" type="audio/mp3" controls="controls"></audio>';
				}

				function createVideoPlayer()
				{
					//https://www.youtube.com/watch?v=iX1_BHfeMt0
					//https://www.youtube.com/watch?v=FRC6RImujHw
					//var youtubeUrl = "https://www.youtube.com/watch?v=FRC6RImujHw";
					var youtubeUrl = "";
					$("#video-player-div").empty();
					document.getElementById('audio-player-div').innerHTML = '';
					document.getElementById('video-player-div').innerHTML = '';
					document.getElementById('video-player-div').innerHTML += '<video id="player" name="video-player" width="640" height="360" preload="none" src="' + youtubeUrl + '"  controls playsinline webkit-playsinline></video>';
				}


				var pausedOnStopPoint = false;

				function convertToSeconds(input) {
					var parts = input.split(':'),
						hours = +parts[0],
						minutes = +parts[1],
						seconds = +parts[2];
					return +( (hours * 3600) + (minutes * 60) + seconds).toFixed(2);
				}

				function convertFromSeconds(totalSeconds) {
					hours = Math.floor(totalSeconds / 3600);
					totalSeconds %= 3600;
					minutes = Math.floor(totalSeconds / 60);
					seconds = Math.floor(totalSeconds % 60);
					
					return ('0'+hours).slice(-2) + ":" + ('0'+minutes).slice(-2) + ":" + ('0'+seconds).slice(-2);
				}

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function consoleLog(str, numTabs = 0) {
					var tempStr = "";
					
					for (var j=0; j < numTabs; ++j) {
						tempStr += "\t";
					}
					
					tempStr += str;
					console.log(tempStr);
				}

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function PoCaMark(themeId, type, url, start, stop, delay, title, notes) {
					this.themeId = themeId;
					this.type = type;
					this.url = url;
					this.start = start;
					this.stop = stop;
					this.delay = delay;
					this.title = title;
					this.notes = notes;
				}
				PoCaMark.prototype.PrintToLog = function() {
					consoleLog("themeId: " + this.themeId, 1);
					consoleLog("type: " + this.type, 1);
					consoleLog("url: " + this.url, 1);
					consoleLog("start: " + this.start, 1);
					consoleLog("stop: " + this.stop, 1);
					consoleLog("delay: " + this.delay, 1);
					consoleLog("title: " + this.title, 1);
					consoleLog("notes: " + this.notes, 1);
					consoleLog("");
				};
				PoCaMark.FromJson = function(json) { //static func, doesn't need object, just class
					var pTemp = JSON.parse(json);
					var p = Object.create(PoCaMark.prototype);
					// copy stuff over
					for (a in pTemp) {
					  p[a] = pTemp[a];
					}
					return p;
				};
				PoCaMark.FromObject = function(pm) {
					var p = Object.create(PoCaMark.prototype);
					// copy stuff over
					for (a in pm) {
					  p[a] = pm[a];
					}
					//p["themeId"] = pm["themeId"];
					//p["type"] = pm["type"];
					//p["url"] = pm["url"];
					//p["start"] = pm["start"];
					//p["stop"] = pm["stop"];
					//p["delay"] = pm["delay"];
					//p["title"] = "";
					//p["notes"] = pm["notes"];
					return p;
				};

				var PoCaMarks = [];
				PoCaMarks.FromJson = function(json) {
					var PoCaMarksTemp = JSON.parse(json);
					var PoCaMarksTemp2 = [];
					for (i=0; i < PoCaMarksTemp.length; ++i)
					{
						var p = new PoCaMark.FromObject(PoCaMarksTemp[i]);
						PoCaMarksTemp2.push(p);
					}
					return PoCaMarksTemp2;
				};
				
				var currentPoCaMarkIndex = 0;
				var currentPoCaMode = 0; //0=edit, 1=play
				var pausedAtTime = new Date();
				var playlistItemSelected = false;
				var newInputTimeA = "";
				var newInputTimeB = "";
				var newInputPoCaDelay = "0";
				var showingPoCaRangeButton = false;
				var newInputPoCaTitle = "";
				var newInputPoCaNotes = "";

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________


				var themeMap = new Map();
				var currentThemeID = "1";

			
				function PoCaTheme(Id, name) {
					this.Id = Id;
					this.name = name;
					this.currentplaylistID = 0;
					this.currentPoCaMarkIndex = 0;
					this.playlistItemSelected = false;
					this.showingPoCaRangeButton = false;
					this.playlistMap = new Map();
					this.PoCaMarks = new Array();
					/*
					this.toJSON = function()
					{
						console.log("PoCaTheme.toJSON");
						return "cat";
					}
					*/
				}
				PoCaTheme.prototype.PrintToLog = function() {
					consoleLog("themeId: " + this.Id, 1);
					consoleLog("name: " + this.name, 1);
					consoleLog("currentplaylistID: " + this.currentplaylistID, 1);
					consoleLog("currentPoCaMarkIndex: " + this.currentPoCaMarkIndex, 1);
					consoleLog("playlistItemSelected: " + this.playlistItemSelected, 1);
					consoleLog("showingPoCaRangeButton: " + this.showingPoCaRangeButton, 1);
					consoleLog("playlistMap: " + this.playlistMap, 1);
					consoleLog("PoCaMarks: " + this.PoCaMarks, 1);
					consoleLog("");
				};
				PoCaTheme.FromJson = function(json) { //static func, doesn't need object, just class
					var pTemp = JSON.parse(json);
					var p = Object.create(PoCaTheme.prototype);
					// copy stuff over
					for (a in pTemp) {
					  p[a] = pTemp[a];
					}
					return p;
				};
				PoCaTheme.FromObject = function(pm) {
					var p = Object.create(PoCaTheme.prototype);
					// copy stuff over
					for (a in pm) {
					  p[a] = pm[a];
					}
					//p["Id"] = pm["Id"];
					//p["name"] = pm["name"];
					//p["currentplaylistID"] = pm["currentplaylistID"];
					//p["currentPoCaMarkIndex"] = pm["currentPoCaMarkIndex"];
					//p["playlistItemSelected"] = pm["playlistItemSelected"];
					//p["showingPoCaRangeButton"] = pm["showingPoCaRangeButton"];
					//p["playlistMap"] = pm["playlistMap"];
					//p["PoCaMarks"] = "";
					p["currentplaylistID"] = 0;
					p["currentPoCaMarkIndex"] = 0;
					p["playlistItemSelected"] = false;
					p["showingPoCaRangeButton"] = false;
					p["playlistMap"] = new Map();
					p["PoCaMarks"] = new Array();
					p["toJSON"] = function()
					{
						var obj = {};
						
						obj["Id"] = this["Id"];
						obj["name"] = this["name"];
						return obj;
					}
					return p;
				};

				var PoCaThemes = [];
				PoCaThemes.FromJson = function(json) {
					var PoCaThemesTemp = JSON.parse(json);
					var PoCaThemesTemp2 = [];
					for (i=0; i < PoCaThemesTemp.length; ++i)
					{
						var p = new PoCaTheme.FromObject(PoCaThemesTemp[i]);
						PoCaThemesTemp2.push(p);
					}
					return PoCaThemesTemp2;
				};
//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function PoCaData(PoCaThemes, PoCaMarks) {
					this.PoCaThemes = PoCaThemes;
					this.PoCaMarks = PoCaMarks;
				}
				PoCaData.prototype.PrintToLog = function() {
					consoleLog("PoCaThemes: " + this.PoCaThemes, 1);
					consoleLog("PoCaMarks: " + this.PoCaMarks, 1);
					consoleLog("");
				};
				/*
				PoCaData.FromObject = function(pm) {
					var p = Object.create(PoCaData.prototype);
					// copy stuff over
					for (a in pm) {
					  p[a] = pm[a];
					}

					return p;
				};
				*/
				var PoCaDataObj = null;
				PoCaData.FromJson = function(json) {
					var PoCaDataTemp = JSON.parse(json);
					var PoCaDataTemp2 = null;

					var PoCaThemesTemp = [];
					for (i=0; i < PoCaDataTemp.PoCaThemes.length; ++i)
					{
						var p = new PoCaTheme.FromObject(PoCaDataTemp.PoCaThemes[i]);
						PoCaThemesTemp.push(p);
					}

					var PoCaMarksTemp = [];
					for (i=0; i < PoCaDataTemp.PoCaMarks.length; ++i)
					{
						var p = new PoCaMark.FromObject(PoCaDataTemp.PoCaMarks[i]);
						PoCaMarksTemp.push(p);
					}

					PoCaDataTemp2 = new PoCaData(PoCaThemesTemp, PoCaMarksTemp);
					return PoCaDataTemp2;
				};
//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function initMainTabOnPageLoad()
				{
					resetTabsOnLoad();

					themeId = 1;

					//var theme = new PoCaTheme(themeId, "Main"); //can't drectly create this otherwise unnecessary fields get outputted on export, don't know why yet!!!
					var src = '{"Id":"1","name":"Main"}'
					var PoCaThemeTemp = JSON.parse(src);
					var theme = new PoCaTheme.FromObject(PoCaThemeTemp);

					addTheme(theme);

					//set first theme tab and it's playlist to active
					playlistItemSelected = false;
					showingPoCaRangeButton = false;
					currentThemeID = "onload";
					switchContextOnDeleteTab("onload"); //must create and initialise media player before calling this!
				}


				function scrollActivePlaylistToItem(nthChildStr)
				{
					console.log("adding class, nstr="+nthChildStr);

					var scrollTo = $('.active-playlist li' + nthChildStr);
					var container = scrollTo.parent();
					container.animate({
						scrollTop: scrollTo.offset().top - container.offset().top + container.scrollTop()
					});
				}
//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function InitBehaviourA() {
					this.name = "BehaviourA";
				}
				InitBehaviourA.prototype.CreatePoCaMark = function(media) {
					//alert(this.name + "- CreatePoCaMark");
				};
				InitBehaviourA.prototype.CreatePoCaRange = function(media, onTheFly) {
					//alert(this.name + "- CreatePoCaRange");
				};
				InitBehaviourA.prototype.setA = function(timeAInSeconds) {
					var timeAHHMMSS = convertFromSeconds(timeAInSeconds);
					newInputTimeA = timeAHHMMSS;
				};
				InitBehaviourA.prototype.setB = function(timeBInSeconds) {
					var timeBHHMMSS = convertFromSeconds(timeBInSeconds);
					newInputTimeB = timeBHHMMSS;
				};

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function InitBehaviourB() {
					this.name = "BehaviourB";
				}
				InitBehaviourB.prototype.CreatePoCaMark = function(media) {
					//alert(this.name + "- CreatePoCaMark");
					console.log(this.name + "- CreatePoCaMark");
				};
				InitBehaviourB.prototype.CreatePoCaRange = function(media, onTheFly) {
					//alert(this.name + "- CreatePoCaRange");
					console.log(this.name + "- CreatePoCaRange");

					var themeId = currentThemeID;
					var url = $("#urlInput")[0].value;

					var timeRange = controls.createSnippet();
					var timeAInSeconds = timeRange[0];  //convertToSeconds($("#timeA")[0].value);
					var timeBInSeconds = timeRange[1];  //convertToSeconds($("#timeB")[0].value);
					var delayInSeconds = document.getElementById("inputPoCaDelay").value;
					
					var pocaTitle = document.getElementById("inputPoCaTitle").value;
					var pocaNotes = document.getElementById("inputPoCaNotes").value;
					
					var typeName = onTheFly ? "PoCaRangeOTF" : "PoCaRange";
					var p = new PoCaMark(themeId, typeName, url, timeAInSeconds, timeBInSeconds, delayInSeconds, pocaTitle, pocaNotes);
					//p.PrintToLog();
					PoCaMarks.push(p);

//var poCaMarksComboBox = $("#PoCaMarksComboBox");
//poCaMarksComboBox.append($("<option />").val(PoCaMarks.length)
//															.html(PoCaMarks.length));
					
					var playlist = $(".active-playlist");
					playlistID++;
					playlistMap.set(playlistID.toString(), p);

					/*
					itemId is the pocamarks index
					playlistMapId is the key in the playlistMap to get the pocamark
					*/

					var newLi = $("<li class='list-group-item " + (onTheFly ? "onTheFly" : "") + "' />")
								.val(playlistID)
								.attr('itemId', PoCaMarks.length -1)
								.append($("<i class='fa fa-arrows grabbable' aria-hidden='true'/>").html("&nbsp;&nbsp;&nbsp;"))
								.append($("<span class='timerangetext' />").html(convertFromSeconds(timeAInSeconds) + " - " + convertFromSeconds(timeBInSeconds)))
								.append($("<span class='ui-icon ui-icon-closethick'/>")); //remove icon and Finalize text css are both float right and are positioned in FIFO order

					if (onTheFly)
					{
						newLi.append( $("<span class='PoCaRangeOTF' />").html("<b>Finalize</b>") );
					}
					
					playlist.append(newLi);
					
					var nthChildIndex = PoCaMarks.length;
					var nthChildStr = ":nth-child(" + nthChildIndex + ")";
//					scrollActivePlaylistToItem(nthChildStr);

					$("#playlistContainer").show();

					//console.log(p);
					//console.log(PoCaMarks[0]);

					//var json = JSON.stringify(p);
					//console.log(json);

					//var p2 = PoCaMark.FromJson(json);
					//p2.PrintToLog();
					
					var json2 = JSON.stringify(PoCaMarks);
					document.getElementById("inputPoCaDataToSave").value = json2;


					
					p.PrintToLog();

					newInputTimeA = newInputTimeB = convertFromSeconds(controls.getTimeB());
//					newInputTimeA = newInputTimeB;
//					$("#timeA").val(newInputTimeB);
					
					var blankTime = "";
//					newInputTimeB = blankTime;

//					$("#timeB").val(blankTime);
//					$("#createPoCaRange").hide();
//					showingPoCaRangeButton = false;
					
					document.getElementById("inputPoCaDelay").value = newInputPoCaDelay = "0";
					document.getElementById("inputPoCaTitle").value = newInputPoCaTitle = "";
					document.getElementById("inputPoCaNotes").value = newInputPoCaNotes = "";
				};
				InitBehaviourB.prototype.setA = function(timeAInSeconds) {
					alert("called legacy func: InitBehaviourB.prototype.setA");
					var timeAHHMMSS = convertFromSeconds(timeAInSeconds);
					newInputTimeA = timeAHHMMSS;
				};
				InitBehaviourB.prototype.setB = function(timeBInSeconds) {
					alert("called legacy func: InitBehaviourB.prototype.setB");
					var timeBHHMMSS = convertFromSeconds(timeBInSeconds);
					newInputTimeB = timeBHHMMSS;
				};

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function InitBehaviour(mode) {
					this.name = "Behaviour";
					this.behaviour = (mode==0) ? new InitBehaviourA() : new InitBehaviourB();
				}
				InitBehaviour.prototype.CreatePoCaMark = function(media) {
					this.behaviour.CreatePoCaMark(media);
				};
				InitBehaviour.prototype.CreatePoCaRange = function(media, onTheFly) {
					this.behaviour.CreatePoCaRange(media, onTheFly);
				};
				InitBehaviour.prototype.setA = function(timeAInSeconds) {
					//alert(this.name + "- setA");
					this.behaviour.setA(timeAInSeconds);
				};
				InitBehaviour.prototype.setB = function(timeBInSeconds) {
					//alert(this.name + "- setB");
					this.behaviour.setB(timeBInSeconds);
				};

				var behaviour = new InitBehaviour(1);

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function stringStartsWith(source, search)
				{
					return source.lastIndexOf(search, 0) === 0;
				}

				function searchPodcastURLs(url)
				{
					var arr = null; 
					
					if (stringStartsWith(url, "file") || !stringStartsWith(url, "http"))
					{
						console.log("searchPodcastURLs prematurely ended");
						return arr;
					}

					var podcastSites = $("#PodcastSite option");
					var numSites = podcastSites.length;
					
					//console.log("Num podcast sites: "+ numSites);
			
					for (var i=0; i< numSites; ++i)
					{
						var podcastsComboBoxId = "#Site" + i + "Podcasts";
						var podcastList = $(podcastsComboBoxId + " option");

						$.each(podcastList,function(idx, item){
							var podcastURL = $(item).attr('value');
							
							if (url == podcastURL)
							{
								var podcastIndex = idx;
								var siteIndex = $(item).parent().attr('value');
								//console.log("Found URL match: " + podcastURL);
								//console.log("podcastIndex: " + podcastIndex);
								//console.log("podcast site Id: " + item.parentNode.id);
								//console.log("podcast site: " + siteIndex);
		
								arr = [siteIndex, podcastIndex];
								return false; //breaks the loop (currently in an inner function)
							}
							
						});

						if (arr)
						{
							return arr;
						}
					}
					return arr;
				}

				
				//setComboBoxesFromPodcastURL
				function setComboBoxesFromPodcastURL(url)
				{
					var comboBoxIndices = searchPodcastURLs(url);
					if (comboBoxIndices)
					{
						//console.log("combo box indices found: " + comboBoxIndices);
						
						//var siteIndex = comboBoxIndices.siteIndex;
						//var podcastIndex = comboBoxIndices.podcastIndex;
						var siteIndex = comboBoxIndices[0];
						var podcastIndex = comboBoxIndices[1];
						
						$("#PodcastSite").val(siteIndex).change();

						var podcastsComboBoxId = "#Site" + siteIndex + "Podcasts";
						$(podcastsComboBoxId).prop('selectedIndex', podcastIndex);
						//$("#" + podcastsComboBoxId)[0].selectedIndex = podcastIndex;
						
						$('#setUrl0').click();
						
						return true;
					}

					$("#PodcastSite").val(0).change();
					
					return false;
				}

				//jQuery('#searchPodcasts').click(function() {
				//	setComboBoxesFromPodcastURL("http://traffic.libsyn.com/force-cdn/highwinds/trainingforclimbing/t4c-podcast-2-x-factors.mp3");
				//	//setComboBoxesFromPodcastURL("https://media.blubrry.com/enormocast/p/enormocast.com/wp-content/uploads/podcasts/Enormo3Kelly1.mp3");
				//});


//import/export
				$('#exportToFileCheckBox').change(function() {
					if(this.checked) {
						$("#filenameToSaveAs").removeClass("disabledText");
						$("#inputFileNameToSaveAs").prop('disabled',false);
					}
					else{
						$("#filenameToSaveAs").addClass("disabledText");
						$("#inputFileNameToSaveAs").prop('disabled',true);
					}
				});
				
				
				function clearExportedURL()
				{
					document.getElementById("inputTinyURL").value = "";
				}
				
				jQuery('#savePoCaDataBtn').click(function() {

					$("#exportedURL").hide();
					//document.getElementById("exportPoCaDataToSaveBase64").value = "";
					document.getElementById("inputTinyURL").value = "";
					
					var fileNameToSaveAs;

					if ($("#exportToFileCheckBox").prop('checked')) {
						
						fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;
						
						if ($.trim(fileNameToSaveAs).length === 0)
						{
							alert("Please enter a valid filename");
							return;
						}
					}

					//JOT need to order the themes according to UI ordering!!!
					var themesArr = Array.from(themeMap.values());
					var tempPoCaMarks = [];

					for (i=0; i < themesArr.length; ++i)
					{
						tempPoCaMarks.push.apply(tempPoCaMarks, themesArr[i].PoCaMarks); //append array to tempPoCaMarks array
					}

					var PoCaDataObj = Object.create(PoCaData.prototype);
					PoCaDataObj.PoCaThemes = themesArr;
					PoCaDataObj.PoCaMarks = tempPoCaMarks;

					var textToSave = JSON.stringify(PoCaDataObj);
					
					console.log(textToSave);
					//generate lzma compressed PoCaMark data for URL query string
					//document.getElementById("exportPoCaDataToSaveBase64").value = btoa(textToSave); //base64 (uncompressed) load test
					try {
						const lib = JsonUrl("lzma");
						lib.compress(textToSave).then(output => {
							var newURL = window.location.protocol + "//" + window.location.host + window.location.pathname + "?data=" + output
							//document.getElementById("exportPoCaDataToSaveBase64").value = newURL;
							document.getElementById("inputTinyURL").value = newURL;
						});
					} catch (err) {
						//document.getElementById("exportPoCaDataToSaveBase64").value = `Unable to compress. Reason: ${err}`;
						document.getElementById("inputTinyURL").value = `Unable to compress. Reason: ${err}`;
					}
					
					$("#exportedURL").show();
					
					
					if ($("#exportToFileCheckBox").prop('checked') == false) {
						return;
					}
					
					var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
					var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
				 
					var downloadLink = document.createElement("a");
					downloadLink.download = fileNameToSaveAs;
					downloadLink.innerHTML = "Download File";
					downloadLink.href = textToSaveAsURL;
					downloadLink.onclick = DestroyClickedElement;
					downloadLink.style.display = "none";
					document.body.appendChild(downloadLink);
				 
					downloadLink.click();
				});

				function DestroyClickedElement(event)
				{
					document.body.removeChild(event.target);
				}
				
				
				function LoadPoCaData(textFromFileLoaded)
				{
					loadingFromPoCaFile = true;
					playerLoadedData = false;

					document.getElementById("inputPoCaDataToSave").value = textFromFileLoaded;

					
					var json2 = textFromFileLoaded;
					
					console.log(json2);
					var PoCaDataObj = PoCaData.FromJson(json2);

					resetTabsOnLoad();

					var PoCaThemes2 = PoCaDataObj.PoCaThemes;
					var PoCaMarks2 = PoCaDataObj.PoCaMarks;
					for (i=0; i < PoCaThemes2.length; ++i)
					{
						PoCaThemes2[i].PrintToLog();
						addTheme(PoCaThemes2[i]); // creates UI tab, theme context, empty playlist
					}

					var videoMediaType = false; //default to audio player
					if (PoCaMarks2.length > 0) {

						videoMediaType = ( stringStartsWith(PoCaMarks2[0].url, "https://www.youtube.") ||
										   stringStartsWith(PoCaMarks2[0].url, "http://www.youtube.")  ||
										   stringStartsWith(PoCaMarks2[0].url, "www.youtube.")
										 );
					}
						
					console.log("PoCaMarks file videoMediaType: " + videoMediaType);
					
					if (videoMediaType)
					{
						createVideoPlayer();
					}
					else
					{
						createAudioPlayer();
					}

					InitMediaPlayer(); //must be called before switchContextOnDeleteTab!!!
					$("#MediaModePanel").hide();
						
					//set first theme tab and it's playlist to active 
					playlistItemSelected = false;
					showingPoCaRangeButton = false;
					currentThemeID = "onload";
					switchContextOnDeleteTab("onload"); //must create and initialise media player before calling this!

					//console.log(json2);

//var poCaMarksComboBox = $("#PoCaMarksComboBox");
//poCaMarksComboBox.empty();
					playlistID = 0;

					for (i=0; i < PoCaMarks2.length; ++i)
					{
						//var playlist = $(".active-playlist");
						var playlist = $("#tabs-" + PoCaMarks2[i].themeId + " .playlist");
						var themePoCaMarks = themeMap.get(PoCaMarks2[i].themeId).PoCaMarks;
						var themePlaylistMap = themeMap.get(PoCaMarks2[i].themeId).playlistMap;
						
						PoCaMarks2[i].PrintToLog();
						themePoCaMarks.push(PoCaMarks2[i]);
//poCaMarksComboBox.append($("<option />").val(PoCaMarks.length)
//.html(PoCaMarks.length));
																
						playlistID++;
						themePlaylistMap.set(playlistID.toString(), PoCaMarks2[i]);
						var tA = convertFromSeconds(PoCaMarks2[i].start);
						var tB = convertFromSeconds(PoCaMarks2[i].stop);
						
						var onTheFly = PoCaMarks2[i].type == "PoCaRangeOTF";

						var newLi = $("<li class='list-group-item " + (onTheFly ? "onTheFly" : "") + "' />")
									.val(playlistID)
									.attr('itemId', themePoCaMarks.length -1)
									.append($("<i class='fa fa-arrows grabbable' aria-hidden='true'/>").html("&nbsp;&nbsp;&nbsp;"))
									.append($("<span class='timerangetext' />").html(tA + " - " + tB))
									.append($("<span class='ui-icon ui-icon-closethick'/>"));//remove icon and Finalize text css are both float right and are positioned in FIFO order

						if (onTheFly)
						{
							newLi.append( $("<span class='PoCaRangeOTF' />").html("<b>Finalize</b>") );
						}
					
						playlist.append(newLi);
					}
					
					if (PoCaMarks2.length > 0)
					{
						$("#playlistContainer").show();

						var foundUrl = false;

						if (videoMediaType)
						{
							$("#SelectPodcast").hide();
						}
						else
						{
							foundUrl = setComboBoxesFromPodcastURL(PoCaMarks2[0].url);
						}

						if (!foundUrl)
						{
							$("#urlInput")[0].value = PoCaMarks2[0].url;
							$('#setUrl').click();
							//setSourceUrl(PoCaMarks[0].url);
						}
					}

					currentPoCaMarkIndex = 0;
//$("#PoCaMarksComboBox").val(currentPoCaMarkIndex+1);

//					$("#PoCaMode").val(2).change(); //set playback mode
					$("#PoCaMode").prop('checked', false).change();

					toggleContentFileOptions();
					loadingFromPoCaFile = false;

					$("#MediaPanel").show();
				}
				
				var loadingFromPoCaFile = false;
				jQuery('#loadPoCaDataBtn').click(function() {
					var fileToLoad = document.getElementById("fileToLoad").files[0];
					var fileReader = new FileReader();
					fileReader.onload = function(fileLoadedEvent) 
					{
					//https://github.com/masotime/json-url
					//http://jsbin.com/cayuhox


						var textFromFileLoaded = fileLoadedEvent.target.result;

						LoadPoCaData(textFromFileLoaded);

					};
					fileReader.readAsText(fileToLoad, "UTF-8");
				});

				$('#expandAdvanced').click(function() {
					var c = '+';
					if ($("#expandAdvanced span").html()[0] == '+') c = '-';
					$("#expandAdvanced span").html(c);

					$('#contentAdvanced').slideToggle('fast');
				});

				function toggleContentFileOptions() {
					var c = '+';
					if ($("#expandFileOptions span").html()[0] == '+') c = '-';
					$("#expandFileOptions span").html(c);

					$('#contentFileOptions').slideToggle('fast');				
				}
				
				$('#expandFileOptions').click(function() {
					toggleContentFileOptions();
				});

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________
				var mediaPlayer = null;
				function InitMediaPlayer() {
				

				
				$('#player').mediaelementplayer({
					alwaysShowControls: true,
					features: ['playpause','volume','loop','current','duration','progress'],
					alwaysShowHours: true,
					audioVolume: 'horizontal',
					audioWidth: 600,
					//audioHeight: 120,

					success: function(media, node, player) {
						mediaPlayer = media;
						
						InitControls(mediaPlayer);
						controls.setCallbackSetA(setA);
						controls.setCallbackSetB(setB);
						
						var sliderHandle = $( "#slider-handle" );

						$('#slider').slider({
							range: false,
							min: 0,
							max: 100,
							orientation: "horizontal",
							values: [0],
							create: function() {
								sliderHandle.text( convertFromSeconds( $( this ).slider( "value" ) ) );
							},

							slide: function(event, ui) {
								var timeInSeconds = ui.value;
								sliderHandle.text( convertFromSeconds(timeInSeconds) );
								
								media.setCurrentTime(timeInSeconds);

							}
						});


						//media.setCurrentTime(101); //initially start playing at specific time
						//media.play();

						jQuery('.bm3').click(function() {
							media.setCurrentTime($("#timeInput")[0].value);
							//media.play();
						});

						jQuery('.cbm').click(function() {
							var timeInSeconds = media.getCurrentTime();
							$("#timeOutput").val(timeInSeconds);
							$("#timeOutput2").val(convertFromSeconds(timeInSeconds));
						});


						var mcTimeThreshold = 300; //220-370
						var firstMCTime = 0;
						var lastMCTime = 0;
						var multiClickCount = 0;

						function createOnTheFlyPoCaRange(multiClickCount)
						{
							var endTime = firstMCTime;
							var startTime = endTime;
							
							switch (multiClickCount)
							{
								case 1: startTime -= 60;   break;
								case 2: startTime -= 60*2; break;
								case 3: startTime -= 60*3; break;
								case 4: startTime -= 60*4; break;
								case 5: startTime -= 60*5; break;
								default:startTime -= 60*6; break;
							}
							
							//clamp the start time!
							startTime =  (startTime < 0) ? 0 : startTime;


							controls.setTimes(startTime, endTime);
							
//							startTime = convertFromSeconds(startTime);
//							endTime = convertFromSeconds(endTime);
//							$("#timeA")[0].value = startTime;
//							$("#timeB")[0].value = endTime;

							document.getElementById("inputPoCaDelay").value = 0;
							document.getElementById("inputPoCaTitle").value = "";
							document.getElementById("inputPoCaNotes").value = "";

							var onTheFly = true;
							behaviour.CreatePoCaRange(media, onTheFly);
						}
												
						jQuery('#multi-click').click(function() {
						
							if (currentPoCaMode == 1) return; //shouldn't work in play mode
						
							++multiClickCount;
							lastMCTime = Date.now();
							
							if (multiClickCount == 1)
							{
								firstMCTime = media.getCurrentTime();
							}
						
							setTimeout(function () {
								
								var time2 = Date.now();

								if (time2 > lastMCTime + mcTimeThreshold)
								{
									console.log("multiClickCount: " + multiClickCount);
									createOnTheFlyPoCaRange(multiClickCount);

									lastMCTime = time2;
									multiClickCount = 0;
								}
							}, mcTimeThreshold + 50);

						});



						jQuery('#createPoCaMark').click(function() {
							behaviour.CreatePoCaMark(media);
						});

						jQuery('#createPoCaRange').click(function() {
						
								clearExportedURL();

							var onTheFly = false;
							behaviour.CreatePoCaRange(media, onTheFly);
						});

						jQuery("#PodcastSite").change(function () {
							//First hide all podcast lists
							var pcListElements = document.getElementsByClassName("SitePodcasts");
							for(var i=0; i<pcListElements.length; i++) {
								pcListElements[i].style.display = 'none';
							}

							//then show the selected site's podcast list
							var selectedSite = $("#PodcastSite").find('option:selected').index();
							if (selectedSite == 0)
							{
								document.getElementById("setUrl0").style.display = 'none';
							}
							else
							{
								document.getElementById("setUrl0").style.display = '';
							}
							
							console.log("selectedSite: " + selectedSite);
							var podcastsComboBoxId = "Site" + selectedSite + "Podcasts";

							$("#" + podcastsComboBoxId).prop('selectedIndex', 0);

							document.getElementById(podcastsComboBoxId).style.display = '';
						});
						
						
						//setUrl0
						jQuery('#setUrl0').click(function() {
							console.log("loadingFromPoCaFile: " + loadingFromPoCaFile);

							clearExportedURL();
							var selectedSite = $("#PodcastSite").find('option:selected').index();
							console.log("selectedSite: " + selectedSite);

							var mp3Url = document.getElementById("Site" + selectedSite + "Podcasts").value
							console.log("mp3Url: " + mp3Url);
							$("#urlInput")[0].value = mp3Url;

							media.setSrc(mp3Url);
							media.load();
						});

						//setUrl
						jQuery('#setUrl').click(function() {
							console.log("loadingFromPoCaFile: " + loadingFromPoCaFile);
							
							clearExportedURL();
							if (!loadingFromPoCaFile)
							{
								var foundUrl = setComboBoxesFromPodcastURL($("#urlInput")[0].value);	
								if (foundUrl)
									return;		
							}
							//IF loading from poca file Or
							//IF NOT loading form poca file AND url not found
							media.setSrc($("#urlInput")[0].value);
							media.load();
						});

						var lastNewInputPoCaDelay = "";
						var lastInputPoCaDelay = "";

						var lastNewInputPoCaTitle = "";
						var lastInputPoCaTitle = "";

						var lastNewInputPoCaNotes = "";
						var lastInputPoCaNotes = "";

						
						function playlistGainedFocus()
						{
						console.log("playlistGainedFocus");
							var timeAInSeconds = PoCaMarks[currentPoCaMarkIndex].start;
							var timeBInSeconds = PoCaMarks[currentPoCaMarkIndex].stop;
							controls.setTimes(timeAInSeconds, timeBInSeconds);

//							var timeAInHHMMSS = convertFromSeconds(PoCaMarks[currentPoCaMarkIndex].start);
//							var timeBInHHMMSS = convertFromSeconds(PoCaMarks[currentPoCaMarkIndex].stop);
//							document.getElementById("timeA").value = timeAInHHMMSS;
//							document.getElementById("timeB").value = timeBInHHMMSS;
							
							lastInputPoCaDelay = document.getElementById("inputPoCaDelay").value = PoCaMarks[currentPoCaMarkIndex].delay;
							lastInputPoCaTitle = document.getElementById("inputPoCaTitle").value = PoCaMarks[currentPoCaMarkIndex].title;
							lastInputPoCaNotes = document.getElementById("inputPoCaNotes").value = PoCaMarks[currentPoCaMarkIndex].notes;
						}

						function resumePlayBack(oldIndex)
						{
							pausedOnStopPoint = false;
							var startTime = 0;
							
							if (PoCaMarks.length > oldIndex) {
								var nthChildIndex = oldIndex;
								nthChildIndex++;

								console.log("nthChildIndex="+nthChildIndex);
								var nthChildStr = ":nth-child(" + nthChildIndex + ")";
								$('.active-playlist li' + nthChildStr).removeClass('currentlyPlaying');
								console.log("removing class, nstr="+nthChildStr);
							}
							
							if (PoCaMarks.length > currentPoCaMarkIndex) {
								startTime = PoCaMarks[currentPoCaMarkIndex].start;
//$("#PoCaMarksComboBox").val(currentPoCaMarkIndex+1);
								var nthChildIndex = currentPoCaMarkIndex;
								nthChildIndex++;

								console.log("nthChildIndex="+nthChildIndex);
								var nthChildStr = ":nth-child(" + nthChildIndex + ")";
								console.log("adding class, nstr="+nthChildStr);
								$('.active-playlist li' + nthChildStr).addClass('currentlyPlaying');

								scrollActivePlaylistToItem(nthChildStr);

								currentplaylistID = $('.active-playlist li' + nthChildStr).attr('value');
								console.log("currentplaylistID="+currentplaylistID);
								
								playlistGainedFocus();
							}
							
							$('#slider').slider('values', 0, startTime);
							sliderHandle.text( convertFromSeconds(startTime) );
							var start = Math.trunc(startTime);
							var end = Math.trunc(PoCaMarks[currentPoCaMarkIndex].stop);
							$("#slider").slider('option', {min: start, max: end});
							
							media.setCurrentTime(startTime);
							
							if (currentPoCaMode == 0) //if in edit mode
							{
								return;
							}
							media.play();
							//media.playbackRate = 1.5;

						} //resumePlayBack

						jQuery("#inputPoCaDelay").on('change keyup paste mouseup', function () {
						
							if (playlistItemSelected)
							{
								if ($(this).val() != lastInputPoCaDelay)
								{
									lastInputPoCaDelay = $(this).val();
									console.log('The delay text box really changed this time');
									PoCaMarks[currentPoCaMarkIndex].delay = $(this).val();
									
									var json2 = JSON.stringify(PoCaMarks);
									document.getElementById("inputPoCaDataToSave").value = json2;	
								}
							}
							else
							{
								if ($(this).val() != lastNewInputPoCaDelay)
								{
									lastNewInputPoCaDelay = newInputPoCaDelay = $(this).val();
									console.log('The delay text box really changed this time');
								}
							}
	
						});

						jQuery("#inputPoCaTitle").on('change keyup paste mouseup', function () {
						
							if (playlistItemSelected)
							{
								if ($(this).val() != lastInputPoCaTitle)
								{
									lastInputPoCaTitle = $(this).val();
									console.log('The title text box really changed this time');
									PoCaMarks[currentPoCaMarkIndex].title = $(this).val();
									
									var json2 = JSON.stringify(PoCaMarks);
									document.getElementById("inputPoCaDataToSave").value = json2;	
								}
							}
							else
							{
								if ($(this).val() != lastNewInputPoCaTitle)
								{
									lastNewInputPoCaTitle = newInputPoCaTitle = $(this).val();
									console.log('The title text box really changed this time');
								}
							}
	
						});

						jQuery("#inputPoCaNotes").on('change keyup paste mouseup', function () {
						
							if (playlistItemSelected)
							{
								if ($(this).val() != lastInputPoCaNotes)
								{
									lastInputPoCaNotes = $(this).val();
									console.log('The notes text box really changed this time');
									PoCaMarks[currentPoCaMarkIndex].notes = $(this).val();
									
									var json2 = JSON.stringify(PoCaMarks);
									document.getElementById("inputPoCaDataToSave").value = json2;	
								}
							}
							else
							{
								if ($(this).val() != lastNewInputPoCaNotes)
								{
									lastNewInputPoCaNotes = newInputPoCaNotes = $(this).val();
									console.log('The notes text box really changed this time');
								}
							}
	
						});

						function updatePlaylistItemTimeText()
						{
							var nthChildIndex = currentPoCaMarkIndex;
							nthChildIndex++;

							console.log("nthChildIndex="+nthChildIndex);
							var nthChildStr = ":nth-child(" + nthChildIndex + ")";
							console.log("updating playlist item time text, nstr="+nthChildStr);

							var tA = convertFromSeconds(PoCaMarks[currentPoCaMarkIndex].start);
							var tB = convertFromSeconds(PoCaMarks[currentPoCaMarkIndex].stop);
							$('.active-playlist li' + nthChildStr + ' .timerangetext').html(tA + " - " + tB);
						}

						function setA(timeAInSeconds) {
							if (currentPoCaMode == 1) return; //shouldn't work in play mode

							if (playlistItemSelected)
							{
								//console.log("TimeA changed: " + timeAInSeconds);
								PoCaMarks[currentPoCaMarkIndex].start = timeAInSeconds;
								updatePlaylistItemTimeText();

								var json2 = JSON.stringify(PoCaMarks);
								document.getElementById("inputPoCaDataToSave").value = json2;	
							}
							else
							{
								newInputTimeA = convertFromSeconds(timeAInSeconds);
								console.log("TimeA changed: " + newInputTimeA);
							}

						}
						function setB(timeBInSeconds) {
							if (currentPoCaMode == 1) return; //shouldn't work in play mode

							if (playlistItemSelected)
							{
								//console.log("TimeB changed: " + timeBInSeconds);
								PoCaMarks[currentPoCaMarkIndex].stop = timeBInSeconds;
								updatePlaylistItemTimeText();

								var json2 = JSON.stringify(PoCaMarks);
								document.getElementById("inputPoCaDataToSave").value = json2;	
							}
							else
							{
								newInputTimeB = convertFromSeconds(timeBInSeconds);
								console.log("TimeB changed: " + newInputTimeB);
							}
						}

						var playerLoadedData = false;
						function hideTimeRail() {
							if (playerLoadedData) //when loading from url/file - we immediately switch to play mode before data is loaded. time bar still needs to be visible to adjust initial slider positions
							{
								$('.mejs__container .mejs__time-rail').css('display','none'); //prevent time changes via progress/seek bar while playing PoCa Marks
							}
						}

						function showTimeRail() {
							$('.mejs__container .mejs__time-rail').css('display','block'); //allow time changes via progress/seek bar in edit mode
						}

						jQuery("#PoCaMode").change(function () {
							if ($("#PoCaMode")[0].checked) {  //edit mode
								currentPoCaMode = 0;
//$("#PoCaMarksComboBox").prop("disabled", true);
								media.pause();
								showTimeRail();
								
								$(".editcontrols").prop("readonly", false);
								
								$("#multi-click").show();
								$(".PoCaRangeOTF").show();

								$("#createButtonsDiv").show();

								controls.enable();
							}
							else {													//play mode
								controls.disable();

								currentPoCaMode = 1;
								var oldIndex = currentPoCaMarkIndex;
								currentPoCaMarkIndex = 0;
								resumePlayBack(oldIndex);
//$("#PoCaMarksComboBox").prop("disabled", false);

//controls.refreshAllSlidersUI();
								hideTimeRail();
								
								$(".editcontrols").prop("readonly", true);
								$(".editcontrolslabel").hide();
								$("#multi-click").hide();
								$(".PoCaRangeOTF").hide();
								
								$("#createButtonsDiv").hide();
							}
						});
						

						//$("#tabs").delegate( ".active-playlist li", "click", function() {
						$("#tabcontents").on("click touchstart", ".active-playlist .list-group-item", function(e) {

							//if (currentPoCaMode == 0) //if in edit mode
							//{
							//	return;
							//}
							var tempPlaylistMapID = $(this).attr('value');

							console.log("playlist item clicked  " + tempPlaylistMapID);

		//					var mark = playlistMap.get(tempPlaylistMapID); //should check with 'has' func first!!!

							var SelectedPoCaIndex = $(this).attr('itemId');
							var oldIndex = currentPoCaMarkIndex;
							currentPoCaMarkIndex = SelectedPoCaIndex;
							resumePlayBack(oldIndex);
						});	

//						$("#tabs").delegate( ".active-playlist li div.PoCaRangeOTF", "click", function(e) {
						$("#tabcontents").on("click touchstart", ".active-playlist .list-group-item .PoCaRangeOTF", function(e) {
							var li = $(this).parent();
							var OtfPoCaIndex = li.attr('itemId');
							PoCaMarks[OtfPoCaIndex].type = "PoCaRange";
							li.removeClass("onTheFly");

							$(this).remove();
							e.stopPropagation(); //stops the bubbling of an event to parent elements. (Prevents li selection)
						});	

						//clicking a tab header makes its playlist active
						function onTabButtonClicked(tabPanelId) {
							tabPanelId = "#" + tabPanelId;
							
							console.log("tabPanelId: " + tabPanelId);
							var nextThemeId = $(tabPanelId).attr("themeId");
							console.log("currentThemeID: " + currentThemeID);
							console.log("nextThemeId: " + nextThemeId);
							if (nextThemeId == currentThemeID)
							{
								console.log("No need to switch theme context");
								return;
							}
							
							media.pause();
							
							var tempPlaylistItemSelected = playlistItemSelected;
							console.log("tempPlaylistItemSelected: " + tempPlaylistItemSelected);

							playlistItemLostFocus();
							
							if (currentThemeID != "onload")
							{
								var currentTheme = themeMap.get(currentThemeID.toString());
								currentTheme.currentplaylistID = currentplaylistID;
								currentTheme.currentPoCaMarkIndex = currentPoCaMarkIndex;
								currentTheme.playlistItemSelected = tempPlaylistItemSelected;
								currentTheme.showingPoCaRangeButton = showingPoCaRangeButton;
								currentTheme.playlistMap = playlistMap;
								currentTheme.PoCaMarks = PoCaMarks;
							}

							
							var nextTheme = themeMap.get(nextThemeId.toString());
							console.log("nextTheme: " + nextTheme);
							currentplaylistID = nextTheme.currentplaylistID;
							currentPoCaMarkIndex = nextTheme.currentPoCaMarkIndex;
							playlistItemSelected = nextTheme.playlistItemSelected;
							showingPoCaRangeButton = nextTheme.showingPoCaRangeButton;
							playlistMap = nextTheme.playlistMap;
							PoCaMarks = nextTheme.PoCaMarks;
							currentThemeID = nextThemeId;

							
							if (playlistItemSelected)
							{
								$(".editcontrolslabel").hide();
								$("#createPoCaRange").hide();
								
								playlistGainedFocus();
							}
							else
							{
								$(".editcontrolslabel").show();

								if (showingPoCaRangeButton)
								{
									$("#createPoCaRange").show();
								}
							}
							
							$("#tabcontents .active-playlist").removeClass("active-playlist");
							$(tabPanelId + " .playlist").addClass("active-playlist");
						}
						playlistUI.setCallbackTabButtons(onTabButtonClicked);


						//jQuery(".active-playlist li").on("onfocus", function() {
						//	console.log("playlist lost focus");
						//});

						function playlistItemLostFocus()
						{
							playlistItemSelected = false;

							$(".editcontrolslabel").show();
							
//							if (showingPoCaRangeButton)
							{
								$("#createPoCaRange").show();
							}

							controls.setTimes(convertToSeconds(newInputTimeA), convertToSeconds(newInputTimeB));
							//document.getElementById("timeA").value = newInputTimeA;
							//document.getElementById("timeB").value = newInputTimeB;
							document.getElementById("inputPoCaDelay").value = newInputPoCaDelay;
							document.getElementById("inputPoCaTitle").value = newInputPoCaTitle;
							document.getElementById("inputPoCaNotes").value = newInputPoCaNotes;
						}
						
						window.addEventListener('mousedown', function(e){   
							if (document.getElementsByClassName('active-playlist')[0].contains(e.target)){
								//playlist clicked
								console.log("playlist clicked focus: ");

								playlistItemSelected = true;
								
								$(".editcontrolslabel").hide();
								$("#createPoCaRange").hide();
								
								playlistGainedFocus();
							}
							else{
								//clicked outside of playlist
							
								if (!( (currentPoCaMode == 1 && $(e.target).parents('.mejs__container').length ) || //clicking the player looses playlist focus only in edit mode
								     $(e.target).hasClass('editcontrols') || $(e.target).closest('.editcontrols').length ||
									 $(e.target).hasClass('tablinks') ))
								{
									console.log("playlist lost focus: " + e.srcElement);
									playlistItemLostFocus();
								}
								
							}
						});
  
						media.addEventListener('pause', function (e) {
							paused = true;
						});

						media.addEventListener('play', function (e) {
							paused = false;
						});

						media.addEventListener('seeking', function (e) {
							controls.onSeeking();
						});

						media.addEventListener('seeked', function (e) {
							controls.onSeeked();
						});
					
						var _lastTime = 0;
						media.addEventListener('playing', function (e) {
							interval = setInterval(function () {
								var currentTime = media.currentTime;

								if (!isNaN(currentTime) && currentTime > 0) {

									if (currentPoCaMode == 1) //play mode
									{
										if (pausedOnStopPoint)
										{
											
											var elapsed = (new Date() - pausedAtTime) / 1000;
											if (elapsed >= PoCaMarks[currentPoCaMarkIndex].delay) {
											
												var oldIndex = currentPoCaMarkIndex;
												currentPoCaMarkIndex++;

												//loop around PoCaMarks
												if (currentPoCaMarkIndex >= PoCaMarks.length) {
													currentPoCaMarkIndex = 0;
												}

												resumePlayBack(oldIndex);
											}
										}
										else { //playing
											
											if (PoCaMarks.length > currentPoCaMarkIndex)
											{
												var cueTime = PoCaMarks[currentPoCaMarkIndex].stop;
												if (cueTime >= _lastTime) {

													sliderHandle.text( convertFromSeconds(currentTime) );
													$('#slider').slider('values', 0, currentTime);
													
													if (cueTime <= currentTime) {
														media.pause();
														pausedAtTime = new Date();
														pausedOnStopPoint = true;
													}
												}
											}
										}
									}
									else if (currentPoCaMode == 0) //edit mode
									{
										if (!paused)
										{
											controls.onPlayTick(currentTime, _lastTime);									
										}
									}

									_lastTime = currentTime;
								}
							}, 50);

						}, false);

						media.addEventListener('loadeddata', function () {
							controls.loadedData();

							if (!loadingFromPoCaFile){
								$("#createButtonsDiv").show();

								playerLoadedData = true;
								if (currentPoCaMode == 1) {
									hideTimeRail();
								}
							}
						});

						controls.refreshAllSlidersUI();
						
					} //success: func...
				});
				}
				
				jQuery("#start").click(function () {
					if ($("#MediaType")[0].checked == false) {  //audio
						if (mediaPlayer != null) {
							mediaPlayer.pause();
							mediaPlayer.setSrc("");
							mediaPlayer.load();
							mediaPlayer.remove();
							mediaPlayer = null;
						}
						createAudioPlayer();
						InitMediaPlayer();
					}
					else {														 //video
						if (mediaPlayer != null) {
							mediaPlayer.pause();
							mediaPlayer.setSrc("");
							mediaPlayer.load();
							mediaPlayer.remove();
							mediaPlayer = null;
						}
						createVideoPlayer();
						InitMediaPlayer();
						
						$("#SelectPodcast").hide();
					}
					
					$("#MediaModePanel").hide();
					$("#loadOption").hide();

					initMainTabOnPageLoad();
					
					$("#MediaPanel").show();
				});

				//still in doc ready func
				//alert($("#urlInput")[0].value);
				//$('setUrl1').trigger('click');


				function removePocaMarkFromLastTheme(lastThemeId, playlistMapIDToRemove)
				{
					var lt = themeMap.get(lastThemeId.toString());

					var markToMove = lt.playlistMap.get(playlistMapIDToRemove.toString());
					lt.playlistMap.delete(playlistMapIDToRemove.toString());

					var liList = $("#tabcontents .tabcontent[themeid=" + lastThemeId + "] .playlist li");

					lt.PoCaMarks.length = 0; //clear the vector
					
					$.each(liList,function(idx, item){
						var tempPlaylistMapID = $(item).attr('value');

						var mark = lt.playlistMap.get(tempPlaylistMapID); //should check with 'has' func first!!!
						lt.PoCaMarks.push(mark);
						
						var itemId = lt.PoCaMarks.length -1;
						$(item).attr('itemId', itemId);
						
						if (tempPlaylistMapID == lt.currentplaylistID)
						{
							lt.currentPoCaMarkIndex = itemId;
							console.log("lt.currentPoCaMarkIndex="+lt.currentPoCaMarkIndex);
						}
					});
					
					return markToMove;
				}


				function PlaylistModified()
				{
					var liList = $(".active-playlist li");

					PoCaMarks.length = 0; //clear the vector
					
					$.each(liList,function(idx, item){
						var tempPlaylistMapID = $(item).attr('value');

						var mark = playlistMap.get(tempPlaylistMapID); //should check with 'has' func first!!!
						//console.log(mark);
						PoCaMarks.push(mark);
						
						var itemId = PoCaMarks.length -1;
						$(item).attr('itemId', itemId);
						
						if (tempPlaylistMapID == currentplaylistID)
						{
							currentPoCaMarkIndex = itemId;
							console.log("currentPoCaMarkIndex="+currentPoCaMarkIndex);
						}
					});
					
					var json2 = JSON.stringify(PoCaMarks);
					document.getElementById("inputPoCaDataToSave").value = json2;	
				}

				$("#tabcontents").on("click touchstart", ".active-playlist .list-group-item .ui-icon-closethick", function(e) {
					var liElem = $(this).parent();
					var tempPlaylistMapID = liElem.val();
					console.log("tempPlaylistMapID: "+tempPlaylistMapID);
					playlistMap.delete(tempPlaylistMapID);

					liElem.remove();
					
					var liList = document.getElementsByClassName('active-playlist')[0].getElementsByTagName("li");
					
					PlaylistModified();
					
					if (themeMap.size == 1 && liList.length == 0)
					{
						console.log("removed last PoCaMark from the only existing theme - hiding playlist container");

						$("#playlistContainer").hide();
					}

					e.stopPropagation(); //stops the bubbling of an event to parent elements. (Prevents li selection)
				});

				function onPlaylistItemMoved(movedToAnotherPlaylist, item, fromElem, oldIndex) {

					if (movedToAnotherPlaylist) {	//NB theme has already switched. so remove pocamark from last theme and insert it into current theme
						var lastThemeId = $(fromElem).parent().attr("themeId");
						console.log("old themeId, index: " + lastThemeId + ", " + oldIndex);

						var playlistMapIDToRemove = $(item).val();
						console.log("playlistMapIDToRemove:"+playlistMapIDToRemove)
						var markToMove = removePocaMarkFromLastTheme(lastThemeId, playlistMapIDToRemove);

						console.log("current theme Id: " + currentThemeID);
						console.log("current playlistMap size: " + playlistMap.size);

						var nextFreePlaylistMapID;
						for(var i = 1; i <= playlistMap.size +1; ++i)
						{
							if (!playlistMap.has(i.toString()))
							{
								console.log("nextFreePlaylistMapId: "+ i);
								nextFreePlaylistMapID = i.toString();
							}
						}
						playlistMap.set(nextFreePlaylistMapID.toString(), markToMove);
						$(item).val(nextFreePlaylistMapID);
					}
					
					PlaylistModified();
					
				}
				playlistUI.setCallbackPlaylistItemMoved(onPlaylistItemMoved);

				InitialiseSortablePlaylist("tabs-1", ".playlist");


				//load PoCaMark data from lzma compressed URL query string - if it exists
				var url_string = window.location.href;
				var url = new URL(url_string);
				var urlData = url.searchParams.get("data");
				
				if (urlData != null && urlData != "")
				{
					//var textFromFileLoaded = atob(textToSave); //base64 (uncompressed) load test
					try {
						const lib = JsonUrl("lzma");
						lib.decompress(urlData).then(textFromFileLoaded => {
							LoadPoCaData(textFromFileLoaded);							
						})
					} catch (err) {
						console.log("Unable to decompress. Reason: ${err}");
					}
				}
				
			}); //ready
			

		</script>


	</body>
</html>
