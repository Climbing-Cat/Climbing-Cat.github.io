<!--
https://softwareengineeringdaily.com/tag/indie-hackers/
http://stackoverflow.com/questions/7605930/how-to-set-start-time-offset-using-setcurrenttime
https://github.com/johndyer/mediaelement/blob/master/docs/api.md
https://designmodo.com/audio-player/
http://butlerccwebdev.net/support/html5-video/mediaelementjs-demo.html
http://folk.uib.no/jvi041/player/examples/_name=loop.html

Time-based events in MediaElements.js
https://github.com/johndyer/mediaelement/issues/707
http://stackoverflow.com/questions/36453069/how-to-add-pause-points-to-mediaelement-js-video-player

local files:
		<script src="js/jquery.js"></script>
		<script src="js/mediaelement-and-player.min.js"></script>
		<link href="css/mediaelementplayer.min.css" rel="stylesheet" />

		online files:
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/mediaelement/latest/mediaelement-and-player.min.js"></script>
		<link href="https://cdn.jsdelivr.net/mediaelement/latest/mediaelementplayer.css" rel="stylesheet" />

Sample URL's
____________
Training Beta (Uses libsyn)
https://traffic.libsyn.com/secure/force-cdn/highwinds/trainingbeta/Danny-Robertson.mp3
http://traffic.libsyn.com/forcedn/trainingbeta/Madaleine-Sorkin.mp3

The Enormocast (Uses blubrry, download link in page)
http://media.blubrry.com/enormocast/p/content.blubrry.com/enormocast/Enormo115PaulRobinson.mp3

Training For Climbing (Uses libsyn. Page has basic time-stamped notes)
http://trainingforclimbing.com/podcast-12-the-10-4-rule-for-effective-projecting-steady-improvement/
search for iframe, then search for:
		var mediaURLLibsyn = "http://traffic.libsyn.com/force-cdn/ec/trainingforclimbing/podcast_12_May2017_The_10-4_Rule_Projecting.mp3";
		var mediaURL = "http://traffic.libsyn.com/force-cdn/ec/trainingforclimbing/podcast_12_May2017_The_10-4_Rule_Projecting.mp3";

http://traffic.libsyn.com/force-cdn/ec/trainingforclimbing/podcast_12_May2017_The_10-4_Rule_Projecting.mp3

The Dirtbag Diaries (uses SoundCloud, not sure how to Extract yet!)
 - search for an iframe with text player
src url will be: http://w.soundcloud.com/player/?url=https%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F319939267&visual=true&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false
the url needs to be URL decoded to: https://api.soundcloud.com/tracks/319939267
then append: /download?client_id=a3e059563d7fd3372b49b37f00a00bcf
OR load the iframe src and search for "download_url":"https://api.soundcloud.com/tracks/319939267/download
then append the correct client_id for the site: ?client_id=a3e059563d7fd3372b49b37f00a00bcf

http://dirtbagdiaries.com/the-bet/
https://api.soundcloud.com/tracks/319939267/download?client_id=a3e059563d7fd3372b49b37f00a00bcf

http://dirtbagdiaries.com/shorts-catching-hope/
https://api.soundcloud.com/tracks/317557821/download?client_id=a3e059563d7fd3372b49b37f00a00bcf

Chalk Talk (CTClimbing Podcast, Uses libsyn, There's a small play button at the bottom of the page. Page contains basic notes)
http://ctclimbingpodcast.com/louieanderson/
http://hwcdn.libsyn.com/p/5/6/a/56a372124be74d07/Ep.7_-_Louie_Anderson.mp3?c_id=7568960&expiration=1493839434&hwt=99520384c73b5174a0512dad57c46be0

Try this! Download from SoundCloud:
http://lifehacker.com/5891635/download-any-mp3-from-soundcloud-with-this-bookmarklet

client_id query string parameter seems to be per site/customer)? - which is why it works for 2 different mp3 urls?

The Power Company Podcast (uses PodBean)
https://powercompanyclimbing.podbean.com/page/1/
search for: data-uri="http://powercompanyclimbing.podbean.com/mf/play/hihu7h/Episode_92_Health_Starts_in_the_Gut_with_Aicacia_Young.mp3" 
change to:           https://powercompanyclimbing.podbean.com/mf/download/hihu7h/Episode_92_Health_Starts_in_the_Gut_with_Aicacia_Young.mp3


The Ledge - A Climbing Life Podcast (uses SoundCloud)
www.theledge.se/podcasts

Jam Crack - The Niall Grimes Climbing Podcast (Uses libsyn)
www.niallgrimes.com/jam-crack-podcast/

The Bad Beta Podcast (Uses libsyn)
http://www.badbetapodcast.com

The Sharp End (uses SoundCloud, seems like a mountaineering podcast)
https://m.soundcloud.com/the_sharp_end

MtnMeister (uses SoundCloud, outdoors podcasts covering climbing, skiing, mountaineering, ultrarunning etc.)
https://player.fm/series/mtnmeister-48469
mtnmeister.com

Ideas for playlist
https://css-tricks.com/draggable-elements-push-others-way/

http://code.makery.ch/library/dart-drag-and-drop/

http://touchpunch.furf.com/

jQuery UI sortables drag to trash - JSFiddle
https://jsfiddle.net/Glutnix/pSgDu/


jquery toggle switch:
https://github.com/timmywil/jquery.onoff
http://proto.io/freebies/onoff/

-->

<html>

	<head>
		<title>WiKiMedia Player</title>

		<link  href="https://refreshless.com/nouislider/distribute/nouislider.min.css?v=1440" rel="stylesheet"/>
		<link rel="stylesheet" href="css/nouislider.mod.css"/>

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		
		<link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/blitzer/jquery-ui.min.css" rel="stylesheet" />
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

	
		<script src="https://refreshless.com/nouislider/distribute/nouislider.min.js?v=1440"></script>

		<link  href="https://cdn.jsdelivr.net/npm/round-slider@1.5.1/dist/roundslider.min.css" rel="stylesheet"/>
		<link  href="css/roundslider.mod.css" rel="stylesheet"/>

		<script src="https://cdn.jsdelivr.net/npm/round-slider@1.5.1/dist/roundslider.min.js"></script>
	
		<link  href="css/mediaelementplayer.min.css" rel="stylesheet" />	
		<script src="js/mediaelement-and-player.min.js"></script>
		<script src="js/mediaelement/renderers/vimeo.js"></script>
		


		<!-- common -->
		<link  href="css/audio-video-switch.onoff.css" rel="stylesheet"/>
		<link  href="css/play-edit-switch.onoff.css" rel="stylesheet"/>
		<script src="js/jquery.onoff.js"></script>
		<link rel="stylesheet" href="css/selectric.css">
		<script src="js/jquery.selectric.min.js"></script>
		<script src="js/controls1.js"></script>
		<link type="text/css" href="css/playlist-container.css" rel="stylesheet" />
		<script src="js/Sortable.js"></script>
		<script src="js/playlist.js"></script>
		<script src="js/json-url.js"></script>


		<script>
			if (window.location.protocol == "file:") {

				window.fetcher = function(url, elementName, onLoadCallback) {
						const req = new XMLHttpRequest();    
						req.onload = () => {
							document.querySelector(elementName).innerHTML = req.responseText;
							onLoadCallback();
						};
						req.onerror = () => {
							console.log("error. start chrome from CLI: chrome.exe  -incognito --allow-file-access-from-files");
						};						
						req.open('GET', url);
						req.send();
					};
			}
			else{
				window.fetcher = function(url, elementName, onLoadCallback) {
						fetch("table.html")
						.then(response => {
							return response.text()
						})
						.then(data => {
							document.querySelector(elementName).innerHTML = data;
							onLoadCallback();
						});
					};
			}
		</script>


		<style type="text/css">
			.sitePodcasts,
			.selectric-wrapper {
				width: 420px;
				font-family: Arial;
			}
			.selectric,
			.selectric-items {
				background: white;
			}
			/* selectric needs the source combobox to be visible in order to properly attach events to it on a mobile device */
			/* so make the container visible but off screen. once c'tor'd allow it to be renderered on screen by remove class 'hide' */
			/* https://css-tricks.com/places-its-tempting-to-use-display-none-but-dont/ */
			.hide {
			   position: absolute !important;
			   top: -9999px !important;
			   left: -9999px !important;
			}

			#add_theme_dialog label, #add_theme_dialog input { display:block; }
			#add_theme_dialog label { margin-top: 0.5em; }
			#add_theme_dialog input, #add_theme_dialog textarea { width: 95%; }
			#add_theme_tab { cursor: pointer; }



			/* The Modal (background) */
			.confirmModal {
			  display: none; /* Hidden by default */
			  position: fixed; /* Stay in place */
			  z-index: 1; /* Sit on top */
			  padding-top: 100px; /* Location of the box */
			  left: 0;
			  top: 0;
			  width: 100%; /* Full width */
			  height: 100%; /* Full height */
			  overflow: auto; /* Enable scroll if needed */
			  background-color: rgb(0,0,0); /* Fallback color */
			  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
			}
			#confirmBox
			{
				/*display: none;*/
				background-color: #eee;
				border-radius: 5px;
				border: 1px solid #aaa;
				position: fixed;
				width: 300px;
				top: 50%;
				left: 50%;
				margin-left: -150px;
				padding: 6px 8px 8px;
				box-sizing: border-box;
				text-align: center;
			}
			#confirmBox button {
				background-color: #ccc;
				display: inline-block;
				border-radius: 3px;
				border: 1px solid #aaa;
				padding: 2px;
				text-align: center;
				width: 80px;
				cursor: pointer;
			}
			#confirmBox button:hover
			{
				background-color: #ddd;
			}
			#confirmBox .message
			{
				text-align: center;
				margin-bottom: 8px;
			}



			/* non playing items */
			.list-group-item,
			.chosen-item,
			.drag-item,
			.ghost-item
			{ color: black; background-color: white; }	/* finalised playlist items */

			.onTheFly,
			.onTheFly.chosen-item,
			.onTheFly.drag-item,
			.onTheFly.ghost-item
			{ color: black; background-color: white; }	/* OTF playlist items */

			.onTheFly .PoCaRangeOTF						/* 'Finalise' */
			{
				display: inline-block;
				float: right;
				margin: 0px;
				margin-right: 30px;
				padding: 0px;
				text-align: center;
				color: #39E884;
				background-color: transparent;
			}


			/* currently playing items */
			.currentlyPlaying,
			.currentlyPlaying.chosen-item,
			.currentlyPlaying.drag-item,
			.currentlyPlaying.ghost-item
			{background-color: #39E884 !important;}		/* finalised playlist items */
			
			.onTheFly.currentlyPlaying,
			.onTheFly.currentlyPlaying.chosen-item,
			.onTheFly.currentlyPlaying.drag-item,
			.onTheFly.currentlyPlaying.ghost-item
			{background-color: #79daff !important;}		/* OTF playlist items */

			.onTheFly.currentlyPlaying .PoCaRangeOTF	/* 'Finalise' */
			{
				display: inline-block;
				float: right;
				margin: 0px;
				margin-right: 30px;
				padding: 0px;
				text-align: center;
				color: #00ac4a;
				background-color: #79daff;
			}

			
			#slider-handle {
				min-width: 1em;
				width: auto;
				height: 1.6em;
				top: 50%;
				margin-top: -.8em;
				text-align: center;
				line-height: 1.6em;
				font-size: 0.75em;
			}
			
			.disabledText {
			   color: darkgrey;
			}


			/* https://www.arungudelli.com/tutorial/css/disable-text-selection-in-html-using-user-select-css-property/ */
			.disable-text-select {
				user-select: none; /* supported by Chrome and Opera */
				-webkit-user-select: none; /* Safari */
				-khtml-user-select: none; /* Konqueror HTML */
				-moz-user-select: none;  /* Firefox */
				-ms-user-select: none;  /* Internet Explorer/Edge */
			}

			/* CSS hide scroll bar, but have element scrollable */
			/* https://stackoverflow.com/questions/43186015/css-hide-scroll-bar-but-have-element-scrollable/43186311 */
			.hide-scrollbar::-webkit-scrollbar {
				width: 0px;
				height: 0px;
				background: transparent; /* make scrollbar transparent */
			}
		</style>
	</head>

	<body>

		<div style="width: 100%; height: 30px;">
			<div style="text-align: center;">
				<div style="display: inline-block;">
					<h1 onclick="window.location.replace(window.location.href.split(/[?#]/)[0]);" >WiKiMedia Player</h1>
					<h5 style="text-align:right;"><i>by Climbing-Cat</i></h5>
				</div>
			</div>

			<div id="MediaModePanel">
				<div class="onoffswitch" style="display: inline-block;">
					<input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="MediaType" >
					<label class="onoffswitch-label" for="MediaType">
						<span class="onoffswitch-inner"></span>
						<span class="onoffswitch-switch"></span>
					</label>
				</div>
				&nbsp;&nbsp;
				<input type="button" id="start" style="position:relative; display: inline-block; top: -10px; height:30px; line-height: 26px; font-size: 14px;" value="Start"></input>
			</div>
			
			<div id="MediaPanel" style="display: none;">
				<div class="playEditSwitch">
					<input type="checkbox" name="playEditSwitch" class="playEditSwitch-checkbox" id="PoCaMode" checked>
					<label class="playEditSwitch-label" for="PoCaMode">
						<span class="playEditSwitch-inner"></span>
						<span class="playEditSwitch-switch"></span>
					</label>
				</div>
				</br>
				</br>

				<div id="podcastPresets" class="hide"></div>
	  
				<input id="urlInput" type="text" name="urlInput" value="" size="75">
				<a href="#" id="setUrl" > Load URL</a>

				<div id="audio-player-div" class="editcontrols"></div>
				<div id="video-player-div" class="editcontrols"></div>

				<div id="controls" style="display: none">
					<div id="nusDiv" class="editcontrols">
						<div id="noUiSlider"></div>
					</div>
					<div id="dials" class="disable-text-select">				
						<div id="dial1box" class="box editcontrols" style="display: inline-block; position: relative; text-align: center;">
							<div id="dial1" class="dial"></div></br>
							<a href="#" id="setDial1">Set Dial</a>
						</div>
						
						<div id="dial2box" class="box editcontrols" style="display: inline-block; position: relative; text-align: center;">
							<div id="dial2" class="dial"></div></br>
							<a href="#" id="lockDial2" style="display:none;">Lock Dial</a>
							<a href="#" id="setDial2">Set Dial</a>
						</div>
						</br></br></br></br>
					</div>				

					<div id="delayDiv" style="display:none;">
						Pause: <input id="inputPoCaDelay" type="text" name="delay" value="0" class="editcontrols"> (s)
						</br>
					</div>


					<div id ="createButtonsDiv" class="editcontrols disable-text-select" style="display:none;">
						<button id="createPoCaMark" style="display:none;">Create Media Mark</button>
						<div id="createPoCaRange" style="border-radius: 6px; background-color: #b0efb1; color: #005000; text-align: center; width: 175px; display:inline-block;">
							<b>Create Snippet <br> from markers</b>
						</div>
						<div id="multi-click" style="border-radius: 6px; background-color: #d71919; color: white; text-align: center; width: 175px; display:inline-block; position:relative;" >
							<b>Create Snippet </br> On The Fly</b>
						</div>
					</div>
					</br>


					<div style="width: 600px; border-style: none;">
						Snippet Title:</br>
						<input id="inputPoCaTitle" type="text" style="width: 100%;" name="title" value="" class="editcontrols"></br>
						Snippet Note:</br>
						<textarea id="inputPoCaNotes" style="width: 100%; resize: none;" rows="6" class="editcontrols"></textarea></br>
					</div>
					</br>

					<div id="playlistContainer" style="display: none;">
						<div id="add_theme_dialog" title="Theme Name">
							<form>
								<fieldset class="ui-helper-reset">
									<input type="text" name="tab_title" id="tab_title" value="" maxlength="20" class="ui-widget-content ui-corner-all" />
								</fieldset>
							</form>					
						</div>

						<button id="add_theme_tab">Add Theme</button>
						<div id="tabsPanel">
							<div id="tab" class="tab tab-group  hide-scrollbar" style="overflow-x: scroll;">
								<button id="tabs-1-button" class="tablinks" data-tabname="tabs-1">
									<span class="tablabel">Main</span>
									<span class="tablinkicon ui-icon ui-icon-closethick"></span>
								</button>
							</div>
							<div id="tabcontents">
								<div id="tabs-1" class="tabcontent disable-text-select" style="display:block;">
									<ul id="playlist-1" class="list-group  hide-scrollbar playlist active-playlist playlistEditable" style="height: 200px; overflow-y: scroll;">
										<li class="list-group-item">
											<span class="ui-icon ui-icon-closethick"></span>
											<i class="fa fa-arrows grabbable" aria-hidden="true">&nbsp;&nbsp;&nbsp;</i>
											Chisel
										</li>
									</ul>
								</div>
							</div>
							<div class="clearfix"></div>
						</div>
						</br>

						<div id="slider" style="width: 520px;  margin-left:40px;">
							<div id="slider-handle" class="ui-slider-handle"></div>
						</div>
						</br>

					</div>
					
						<div id="exportFilePanel">
							<p><a id="expandExportFileOptions" href="#"><span>+</span>Export Media Snippets File</a>
							<div id="contentExportFileOptions" style="display: none;">

								<div id="exportPanel">
									<button id = "savePoCaDataBtn">Export URL</button>
									</br>
									<div>
										<input type="checkbox" id="exportToFileCheckBox" />
										<label id="filenameToSaveAs" class="disabledText">Filename to Save As:<input id="inputFileNameToSaveAs" disabled/></label>
									</div>
									</br>

									<div id="exportedURL" style="display:none; width: 600px; border-style: none;">
										<form id="tinyURLForm" action="https://tinyurl.com/create.php" method="post" >
											<table style="width: 600px;" align="center" cellpadding="5" bgcolor="#E7E7F7"><tr ><td >
											<b>Exported URL:  </b><br/>
											<input type="text" name="url" id="inputTinyURL" size="68"><input type="submit" name="submit" value="Create a tinyURL"/>
											</td></tr></table>
										</form>
									</div>
								</div>
							</div>
						</div>

				</div>

			</div>

			<div id="importFilePanel">
				<p><a id="expandImportFileOptions" href="#"><span>+</span>Import Media Snippets File</a>
				<div id="contentImportFileOptions" style="display: none;">
					<div id="importPanel">
						<table>
							<tr>
								<td>Select a Media Snippets File to Load:</td>
								<td><input type="file" id="fileToLoad"></td>
								<td><button id="loadPoCaDataBtn">Import </button><td>
							</tr>
						</table>
					</div>
				</div>
			</div>
			</br>
			</br>
			<div id="PoCaFilesPanel">
				<h3>Snippet Files</h3>
				<b>Training 4 Climbing (Eric Hörst)</b></br>
				<a href="?file=T4C 36.txt" >T4C #36 - Training to Increase Tendon Strength, Muscle Power, and Connective Tissue Health</a></br>
				<a href="?file=T4C 35.txt" >T4C #35 - Ask Coach Horst – Round 5</a></br>
				<a href="?file=T4C 34.txt" >T4C #34 - A Revolution in Finger Training for Climbers</a></br>
				<a href="?file=T4C 33.txt" >T4C #33 - Intro to Training for Stronger Tendons and Ligaments</a></br>

				</br>
				<b>Training Beta Podcast (Neely Quinn)</b></br>
				<a href="?file=TBP 113 - dru-mack.txt" >TBP 113 - How Dru Mack Is So Good at Endurance Climbing</a></br>
				<a href="?file=TBP 100 - kyra-condie.txt" >TBP 100 - Kyra Condie's Hangboard and Campus Board Training Program</a></br>
				<a href="?file=TBP 17 - Adam-Ondra.txt" >TBP 17 - Adam Ondra on All Things Training</a></br>

				</br>
				<b>Power Company Climbing (Kris Hampton, Nathan Drolet)</b></br>
				<a href="?file=PCC 51.txt" >PCC - Episode 51 Finger Health with Dr Lisa Erickson</a></br>

				</br>
				</br>
				</br>
			</div>
			</br>
		</div>

		<div id="confirmModal" class="confirmModal">
			<div id="confirmBox">
				<div class="message"></div>
				<button class="yes">Yes</button>
				<button class="no">No</button>
			</div>
		</div>

		<script>
		//start of theme tabs panel functionality
		/*
			Theme (context) objects will be stored in theme map themeID->themeObject
			On page load, default theme (main) object will need to be created
			On PoCa file load, all current themes cleared and new ones created from data file
			Theme tabs and separate playlist divs created

			Theme object variables needed to maintain/switch context:
			themeId
			theme name
			currentplaylistID
			currentPoCaMarkIndex
			playlistMap
			PoCaMarks

			_____________________________
			
			when switching context (theme):
			1. stop playback
			2. ? global playlistItemSelected will need to be set to false AND run the logic associated with setting to false ?
			2. backup global variables to current context object
			3. copy next context variables to global scope
			
		*/
			var playlistID = 0; //global - across themes
			var playlistMap = new Map();
			var currentplaylistID = 0;


			var paused = true;


			$(document).ready(function() {
				function onTableHtmlLoaded() {
					$('.sitePodcasts').show();

					$('.sitePodcasts').selectric(
					{
						preventWindowScroll : false,
					});
					$('.selectric-wrapper').hide();
					$('#Site0Podcasts').parent().parent().show();
					
					$("#podcastPresets").removeClass("hide");
				}
				window.fetcher("table.html", "#podcastPresets", onTableHtmlLoaded);


				//fixes same page links on github pages. Maybe base ref is not set correctly?
				//regardless, clicking a link now does nothing instead of going to the top of the page
				$('a[href="#"]').prop('href','javascript:void(0);');

				$("#MediaType").onoff();
				//$("#PoCaMode").onoff(); //doesn;t seem to work. calling onoff once is enough?


				//also see: https://dtbaker.net/blog/submit-a-form-into-a-popup/
				$('#tinyURLForm').submit(function() {
					let newWindow = window.open('', 'formpopup', 'width=400,height=400,resizeable,scrollbars, status=no,location=no,toolbar=no, left=100, top=300');
					this.target = 'formpopup';
				});


				InitialiseSortableTabs("tab", ".tab-group");


				//https://www.w3schools.com/howto/tryit.asp?filename=tryhow_css_modal
				//https://stackoverflow.com/questions/9334636/how-to-create-a-dialog-with-yes-and-no-options
				//	https://jsfiddle.net/kevalbhatt18/6uauqLn6/
				function showConfirmDialog(msg, yesFn, noFn)
				{
					function closeConfirmDialog()
					{
						$("#confirmModal").hide();
					}
					
					var confirmBox = $("#confirmBox");
					confirmBox.find(".message").text(msg);
					confirmBox.find(".yes,.no").unbind().on("click touchstart", function() {
						closeConfirmDialog();
					});
					confirmBox.find(".yes").on("click touchstart", yesFn);
					confirmBox.find(".no").on("click touchstart", noFn);
					
					$("#confirmModal").show();
				}


//tabs
var tabTitle = $( "#tab_title" );
var tabTitleSanitized = "";
var tabTemplate = "<button id='#{href}-button' class='tablinks tab-group-item' data-tabname='#{href}'><span class='tablabel'>#{label}</span></button>";

const  maxTabs = 5;


function doesThemeAlreadyExist()
{
	var newLabel = tabTitle.val();
	newLabel = newLabel.replace("&nbsp;", " ").replace("&#9;", " ")
					   .replace("&nbsp", " ").replace("&#9", " ").trim();
	tabTitleSanitized = newLabel;
	if (newLabel.length == 0 || newLabel.includes("\\") || newLabel.includes("&")) return true;

	return ($("#tab .tablinks .tablabel").filter(
		function() {
			return $(this).text() == newLabel;
		})
		.length > 0);
}

// modal dialog init: custom buttons and a "close" callback resetting the form inside
var dialog = $( "#add_theme_dialog" ).dialog({
	autoOpen: false,
	modal: true,
	buttons: {
		Add: function() {
			if (!doesThemeAlreadyExist())
			{
				addTab();
				$( this ).dialog( "close" );
			}
		},
		Cancel: function() {
			$( this ).dialog( "close" );
		}
	},
	close: function() {
		form[ 0 ].reset();
	}
});


// addTab form: calls addTab function on submit and closes the dialog
var form = dialog.find( "form" ).submit(function( event ) {

	if (!doesThemeAlreadyExist())
	{
		addTab();
		dialog.dialog( "close" );
	}
	event.preventDefault();
});

function hideAddButtonThemeWhenMaxReached()
{
	if (themeMap.size >= maxTabs) //>= instead of ==, incase loading from file - which can be tampered with/or legacy file?
	{
		$( "#add_theme_tab" ).hide();
	}
}

function findNextFreeThemeId()
{
	if (themeMap.size >= maxTabs)
	{
		console.log("Max Themes reached! No free themeId available.");
		return null;
	}
	
	for(var nextThemeId = 1; nextThemeId <= maxTabs; ++nextThemeId)
	{
		if (!themeMap.has(nextThemeId.toString()))
		{
			console.log("nextFreeThemeId: "+ nextThemeId);
			return nextThemeId.toString();
		}
	}

	console.log("No free themeId available!");
	return null;
}

// actual addTab function: adds new tab using the input from the form
function addTab() {
	var themeId = findNextFreeThemeId();
	var label = tabTitleSanitized || "Tab " + themeId;
	//var theme = new PoCaTheme(themeId, label); //can't directly create this otherwise unnecessary fields get outputted on export, don't know why yet!!!
	var src = '{"Id":"' + themeId + '","name":"' + label + '"}'
	var PoCaThemeTemp = JSON.parse(src);
	var theme = new PoCaTheme.FromObject(PoCaThemeTemp);
	
	addTheme(theme);
}

function addTheme(theme) {
	var themeId = theme.Id.toString();
	var label = theme.name;

	var id = "tabs-" + themeId;
	var li = $( tabTemplate.replace( /#\{href\}/g, id ).replace( /#\{label\}/g, label ) );


	$("#tab").append( li );
	$("#tabsPanel #tabcontents").append( "<div id='" + id + "' themeId='" + themeId + "'  class='tabcontent disable-text-select'>" +
	"<ul id='playlist-" + themeId + "' style='max-height: " + playlistPxHeight + "px; height: " + playlistPxHeight + "px; overflow-y: scroll;' class='list-group hide-scrollbar playlist playlistEditable'></ul>" +
	"</div>" );
	
	themeMap.set(themeId.toString(), theme);

	if (themeMap.size > 1) { //more than 1 tab button on screen. find the tab button w/o close icon and add one (it will be the first tab that was added)
		$("#tab .tablinks:not(:has(.ui-icon-closethick))").append("<span class='tablinkicon ui-icon ui-icon-closethick'></span>");
	}
	
	InitialiseSortablePlaylist(id, ".playlist");
	
	hideAddButtonThemeWhenMaxReached();
}

// addTab button: opens the dialog
$( "#add_theme_tab" ).button().click(function() {
		dialog.dialog( "open" );
});


function switchContextOnDeleteTab(themeId) //switch context to first theme that isn't the currently deleting theme
{
	var mapKeys = themeMap.keys();
	var nextThemeId = mapKeys.next().value;
	if (nextThemeId == themeId)
	{
		nextThemeId = mapKeys.next().value;
	}
	console.log("nextThemeId: "+ nextThemeId);

	$("#tabs-" + nextThemeId + "-button").click();
}


function removeTabAllowed()
{
	if ($("#tab .tablinks").length == 1)
	{
		return false;
	}
	
	return true;
}

function afterRemoveTab(themeId)
{
	if (themeMap.size == 1)
	{
		$( "#tab .tablinks .ui-icon-closethick" ).remove();
	}

	if (themeMap.size < maxTabs)
	{
		$( "#add_theme_tab" ).show();
	}
}

function removeTab(el) {
	var panelId = $( el ).parent().remove().data("tabname");
	var panel = $( "#" + panelId );
	var themeId = panel.attr('themeid');
	$( "#" + panelId ).remove();

	if (themeId == currentThemeID) //closing a tab via x-icon - tab might be active/current (theme context might be current, so switch it if this is the case)
	{
		//switch context to first theme that isn't the currently deleting theme
		switchContextOnDeleteTab(themeId);
	}

	themeMap.delete(themeId);
	console.log("removed theme (Id=" + themeId + ") from themeMap");

	afterRemoveTab(themeId);
}

function confirmRemoveTab(el) {
	showConfirmDialog("Removing Theme: Are you sure?",
		function yes() {
			removeTab(el);
		},
		function no() { }
	);
}

// Remove the tab on clicking close icon click
$("#tab").on("click touchstart", ".tablinks .ui-icon-closethick", function(e) {
	if (!removeTabAllowed()) return;

	confirmRemoveTab(this);
	e.stopPropagation(); //stops the bubbling of an event to parent elements. (Prevents li selection)
});


function resetTabsOnLoad()
{
	DestroyAllSortablePlaylists();
	$("#tab .tablinks").remove();
	$("#tabspanel #tabcontents .tabcontent").remove();
	themeMap.clear();
}


//end of theme tabs panel functionality



//_______________________________________________________________________________________________________________
//_______________________________________________________________________________________________________________

		
				if (!Date.now) {
					Date.now = function() { return new Date().getTime(); }
				}

				function get_style_rule_value(selector, style)
				{
					var selector_compare=selector.toLowerCase();
					var selector_compare2= selector_compare.substr(0,1)==='.' ?  selector_compare.substr(1) : '.'+selector_compare;

					for (var i = 0; i < document.styleSheets.length; i++)
					{
						var mysheet = document.styleSheets[i];

						try
						{
							var myrules = mysheet.cssRules ? mysheet.cssRules : mysheet.rules;

							for (var j = 0; j < myrules.length; j++)
							{
								if (myrules[j].selectorText)
								{
									var check = myrules[j].selectorText.toLowerCase();
									switch (check)
									{
										case selector_compare  :
										case selector_compare2 : return myrules[j].style[style];
									}
								}
							}
						} //try
						catch(err)
						{}
					} //for
				} //func
	 
				function get_style_rule_Float_value(selector, style)
				{
					var temp = get_style_rule_value(selector, style);
					
					return parseFloat(temp, 10);
				}

				//set playlist height
				var paddingTop = get_style_rule_Float_value('.list-group-item', 'padding-top');
				var paddingBottom = get_style_rule_Float_value('.list-group-item', 'padding-bottom');
				var height = get_style_rule_Float_value('.list-group-item', 'height');
				var marginTop = get_style_rule_Float_value('.list-group-item', 'margin-top');
				var marginBottom = get_style_rule_Float_value('.list-group-item', 'margin-bottom');
				var borderTop = get_style_rule_Float_value('.list-group-item', 'border-top');
				var borderBottom = get_style_rule_Float_value('.list-group-item', 'border-bottom');
				var parentBorderBottom = get_style_rule_Float_value('.tabcontent', 'border-bottom');
				var playlistItemPxHeight = marginTop + borderTop + paddingTop + height + paddingBottom + borderBottom + marginBottom;
				var playlistItemsToDisplay = 5;
				var playlistPxHeight = playlistItemPxHeight * playlistItemsToDisplay;
				playlistPxHeight -= marginBottom;

				//var itemHeightPx = getComputedStyle($("#playlist-1 .list-group-item:nth-child(1)").get()[0]).height; //18.4px
				/*
				console.log("paddingTop: " + paddingTop);
				console.log("paddingBottom: " + paddingBottom);
				console.log("height: " + height);
				console.log("marginTop: " + marginTop);
				console.log("marginBottom: " + marginBottom);
				console.log("borderTop: " + borderTop);
				console.log("borderBottom: " + borderBottom);
				*/
				console.log("playlistItemPxHeight: " + playlistItemPxHeight);
				console.log("playlistItemsToDisplay: " + playlistItemsToDisplay);
				console.log("playlistPxHeight:" + playlistPxHeight);

 				$(".playlist").attr('style', "max-height: " + playlistPxHeight + "px; height: " + playlistPxHeight + "px; overflow-y: auto;");

				
				//https://css-tricks.com/snippets/javascript/inject-new-css-rules/
				function injectCssStyles(rule) {
					var div = $("<div />", {
						html: '&shy;<style>' + rule + '</style>'
					}).children().appendTo("body");    
				}
				injectCssStyles('.drag-item { max-height: ' + playlistItemPxHeight + 'px; line-height: ' + height + 'px; }');


				$("#playlistContainer").show();


				function createAudioPlayer()
				{
					var mp3Url = "";
					$("#audio-player-div").empty();
					document.getElementById('audio-player-div').innerHTML = '';
					document.getElementById('video-player-div').innerHTML = '';
					document.getElementById('audio-player-div').innerHTML += '<audio id="player" name="audio-player" src="' + mp3Url + '" type="audio/mp3" controls="controls"></audio>';
				}

				function createVideoPlayer()
				{
					//https://www.youtube.com/watch?v=iX1_BHfeMt0
					//https://www.youtube.com/watch?v=FRC6RImujHw
					//var youtubeUrl = "https://www.youtube.com/watch?v=FRC6RImujHw";
					var youtubeUrl = "";
					$("#video-player-div").empty();
					document.getElementById('audio-player-div').innerHTML = '';
					document.getElementById('video-player-div').innerHTML = '';
					document.getElementById('video-player-div').innerHTML += '<video id="player" name="video-player" width="640" height="360" preload="none" src="' + youtubeUrl + '"  controls playsinline webkit-playsinline></video>';
				}


				var pausedOnStopPoint = false;

				function convertToSeconds(input) {
					var parts = input.split(':'),
						hours = +parts[0],
						minutes = +parts[1],
						seconds = +parts[2];
					return +( (hours * 3600) + (minutes * 60) + seconds).toFixed(2);
				}

				function convertFromSeconds(totalSeconds) {
					hours = Math.floor(totalSeconds / 3600);
					totalSeconds %= 3600;
					minutes = Math.floor(totalSeconds / 60);
					seconds = Math.floor(totalSeconds % 60);
					
					return ('0'+hours).slice(-2) + ":" + ('0'+minutes).slice(-2) + ":" + ('0'+seconds).slice(-2);
				}

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function consoleLog(str, numTabs = 0) {
					var tempStr = "";
					
					for (var j=0; j < numTabs; ++j) {
						tempStr += "\t";
					}
					
					tempStr += str;
					console.log(tempStr);
				}

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function PoCaMark(themeId, type, url, start, stop, delay, title, notes) {
					this.themeId = themeId;
					this.type = type;
					this.url = url;
					this.start = start;
					this.stop = stop;
					this.delay = delay;
					this.title = title;
					this.notes = notes;
				}
				PoCaMark.prototype.PrintToLog = function() {
					consoleLog("themeId: " + this.themeId, 1);
					consoleLog("type: " + this.type, 1);
					consoleLog("url: " + this.url, 1);
					consoleLog("start: " + this.start, 1);
					consoleLog("stop: " + this.stop, 1);
					consoleLog("delay: " + this.delay, 1);
					consoleLog("title: " + this.title, 1);
					consoleLog("notes: " + this.notes, 1);
					consoleLog("");
				};
				PoCaMark.FromJson = function(json) { //static func, doesn't need object, just class
					var pTemp = JSON.parse(json);
					var p = Object.create(PoCaMark.prototype);
					// copy stuff over
					for (a in pTemp) {
					  p[a] = pTemp[a];
					}
					return p;
				};
				PoCaMark.FromObject = function(pm) {
					var p = Object.create(PoCaMark.prototype);
					// copy stuff over
					for (a in pm) {
					  p[a] = pm[a];
					}
					return p;
				};

				var PoCaMarks = [];
				PoCaMarks.FromJson = function(json) {
					var PoCaMarksTemp = JSON.parse(json);
					var PoCaMarksTemp2 = [];
					for (i=0; i < PoCaMarksTemp.length; ++i)
					{
						var p = new PoCaMark.FromObject(PoCaMarksTemp[i]);
						PoCaMarksTemp2.push(p);
					}
					return PoCaMarksTemp2;
				};
				
				var currentPoCaMarkIndex = 0;
				var currentPoCaMode = 0; //0=edit, 1=play
				var pausedAtTime = new Date();
				var playlistItemSelected = false;
				var newInputTimeA = "";
				var newInputTimeB = "";
				var newInputPoCaDelay = "0";
				var showingPoCaRangeButton = false;
				var newInputPoCaTitle = "";
				var newInputPoCaNotes = "";

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________
				var fileFormatVersion = "1";
				var author = "Climbing Cat";
				var dateCreated = Date().toString();
				var dateModified = dateCreated;
				var AllPoCaItemsHaveSharedUrl = true;
				var sharedUrl = "";
				var totalSnippetSecondsAtLoadTime;

				var themeMap = new Map();
				var currentThemeID = "1";

			
				function PoCaTheme(Id, name) {
					this.Id = Id;
					this.name = name;
					this.currentplaylistID = 0;
					this.currentPoCaMarkIndex = 0;
					this.playlistItemSelected = false;
					this.showingPoCaRangeButton = false;
					this.playlistMap = new Map();
					this.PoCaMarks = new Array();
				}
				PoCaTheme.prototype.PrintToLog = function() {
					consoleLog("themeId: " + this.Id, 1);
					consoleLog("name: " + this.name, 1);
					consoleLog("currentplaylistID: " + this.currentplaylistID, 1);
					consoleLog("currentPoCaMarkIndex: " + this.currentPoCaMarkIndex, 1);
					consoleLog("playlistItemSelected: " + this.playlistItemSelected, 1);
					consoleLog("showingPoCaRangeButton: " + this.showingPoCaRangeButton, 1);
					consoleLog("playlistMap: " + this.playlistMap, 1);
					consoleLog("PoCaMarks: " + this.PoCaMarks, 1);
					consoleLog("");
				};
				PoCaTheme.FromJson = function(json) { //static func, doesn't need object, just class
					var pTemp = JSON.parse(json);
					var p = Object.create(PoCaTheme.prototype);
					// copy stuff over
					for (a in pTemp) {
					  p[a] = pTemp[a];
					}
					return p;
				};
				PoCaTheme.FromObject = function(pm) {
					var p = Object.create(PoCaTheme.prototype);
					// copy stuff over
					for (a in pm) {
					  p[a] = pm[a];
					}
					p["currentplaylistID"] = 0;
					p["currentPoCaMarkIndex"] = 0;
					p["playlistItemSelected"] = false;
					p["showingPoCaRangeButton"] = false;
					p["playlistMap"] = new Map();
					p["PoCaMarks"] = new Array();
					p["toJSON"] = function()
					{
						var obj = {};
						
						obj["Id"] = this["Id"];
						obj["name"] = this["name"];
						return obj;
					}
					return p;
				};

				var PoCaThemes = [];
				PoCaThemes.FromJson = function(json) {
					var PoCaThemesTemp = JSON.parse(json);
					var PoCaThemesTemp2 = [];
					for (i=0; i < PoCaThemesTemp.length; ++i)
					{
						var p = new PoCaTheme.FromObject(PoCaThemesTemp[i]);
						PoCaThemesTemp2.push(p);
					}
					return PoCaThemesTemp2;
				};
//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function PoCaData(FileFormatVersion, Author, DateCreated, DateModified, url, PoCaThemes, PoCaMarks) {
					this.FileFormatVersion = FileFormatVersion;
					this.Author = Author;
					this.DateCreated = DateCreated;
					this.DateModified = DateModified;
					this.SharedUrl = url;
					this.PoCaThemes = PoCaThemes;
					this.PoCaMarks = PoCaMarks;
				}
				PoCaData.prototype.PrintToLog = function() {
					consoleLog("FileFormatVersion: " + this.FileFormatVersion, 1);
					consoleLog("Author: " + this.Author, 1);
					consoleLog("DateCreated: " + this.DateCreated, 1);
					consoleLog("DateModified: " + this.DateModified, 1);
					consoleLog("SharedUrl: " + this.SharedUrl, 1);
					consoleLog("PoCaThemes: " + this.PoCaThemes, 1);
					consoleLog("PoCaMarks: " + this.PoCaMarks, 1);
					consoleLog("");
				};

				var PoCaDataObj = null;
				PoCaData.FromJson = function(json) {
					var PoCaDataTemp = JSON.parse(json);
					var PoCaDataTemp2 = null;
					var fileFormatVer = PoCaDataTemp.FileFormatVersion ? PoCaDataTemp.FileFormatVersion : "1";
					var auth = PoCaDataTemp.Author ? PoCaDataTemp.Author : "";
					var createdDate = PoCaDataTemp.DateCreated ? PoCaDataTemp.DateCreated : "";
					var modifiedDate = PoCaDataTemp.DateModified ? PoCaDataTemp.DateModified : "";
					var url = PoCaDataTemp.SharedUrl ? PoCaDataTemp.SharedUrl : "";

					var PoCaThemesTemp = [];
					for (i=0; i < PoCaDataTemp.PoCaThemes.length; ++i)
					{
						var p = new PoCaTheme.FromObject(PoCaDataTemp.PoCaThemes[i]);
						PoCaThemesTemp.push(p);
					}

					var PoCaMarksTemp = [];
					for (i=0; i < PoCaDataTemp.PoCaMarks.length; ++i)
					{
						var p = new PoCaMark.FromObject(PoCaDataTemp.PoCaMarks[i]);
						PoCaMarksTemp.push(p);
					}

					PoCaDataTemp2 = new PoCaData(fileFormatVer, auth, createdDate, modifiedDate, url, PoCaThemesTemp, PoCaMarksTemp);
					return PoCaDataTemp2;
				};
//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function initMainTabOnPageLoad()
				{
					resetTabsOnLoad();

					themeId = 1;

					//var theme = new PoCaTheme(themeId, "Main"); //can't drectly create this otherwise unnecessary fields get outputted on export, don't know why yet!!!
					var src = '{"Id":"1","name":"Main"}'
					var PoCaThemeTemp = JSON.parse(src);
					var theme = new PoCaTheme.FromObject(PoCaThemeTemp);

					addTheme(theme);

					//set first theme tab and it's playlist to active
					playlistItemSelected = false;
					showingPoCaRangeButton = false;
					currentThemeID = "onload";
					switchContextOnDeleteTab("onload"); //must create and initialise media player before calling this!
				}


				function scrollActivePlaylistToItem(nthChildStr)
				{
					console.log("scrolling to item, nstr="+nthChildStr);

					var scrollTo = $('.active-playlist li' + nthChildStr);
					var container = scrollTo.parent();
					container.animate({
						scrollTop: scrollTo.offset().top - container.offset().top + container.scrollTop()
					});
				}
//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function InitBehaviourA() {
					this.name = "BehaviourA";
				}
				InitBehaviourA.prototype.CreatePoCaMark = function(media) {
				};
				InitBehaviourA.prototype.CreatePoCaRange = function(media, onTheFly) {
				};
				InitBehaviourA.prototype.setA = function(timeAInSeconds) {
					var timeAHHMMSS = convertFromSeconds(timeAInSeconds);
					newInputTimeA = timeAHHMMSS;
				};
				InitBehaviourA.prototype.setB = function(timeBInSeconds) {
					var timeBHHMMSS = convertFromSeconds(timeBInSeconds);
					newInputTimeB = timeBHHMMSS;
				};

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function InitBehaviourB() {
					this.name = "BehaviourB";
				}
				InitBehaviourB.prototype.CreatePoCaMark = function(media) {
					console.log(this.name + "- CreatePoCaMark");
				};
				InitBehaviourB.prototype.CreatePoCaRange = function(media, onTheFly) {
					console.log(this.name + "- CreatePoCaRange");

					var themeId = currentThemeID;
					var url = $("#urlInput")[0].value;

					var timeRange = controls.createSnippet();
					var timeAInSeconds = timeRange[0];
					var timeBInSeconds = timeRange[1];
					var delayInSeconds = document.getElementById("inputPoCaDelay").value;
					
					var pocaTitle = document.getElementById("inputPoCaTitle").value;
					var pocaNotes = document.getElementById("inputPoCaNotes").value;
					
					var typeName = onTheFly ? "PoCaRangeOTF" : "PoCaRange";
					var p = new PoCaMark(themeId, typeName, url, timeAInSeconds, timeBInSeconds, delayInSeconds, pocaTitle, pocaNotes);
					PoCaMarks.push(p);
					
					var playlist = $(".active-playlist");
					playlistID++;
					playlistMap.set(playlistID.toString(), p);

					/*
					itemId is the pocamarks index
					playlistMapId is the key in the playlistMap to get the pocamark
					*/

					var newLi = $("<li class='list-group-item " + (onTheFly ? "onTheFly" : "") + "' />")
								.val(playlistID)
								.attr('itemId', PoCaMarks.length -1)
								.append($("<i class='fa fa-arrows grabbable' aria-hidden='true'/>").html("&nbsp;&nbsp;&nbsp;"))
								.append($("<span class='timerangetext' />").html(convertFromSeconds(timeAInSeconds) + " - " + convertFromSeconds(timeBInSeconds)))
								.append($("<span class='ui-icon ui-icon-closethick'/>")); //remove icon and Finalize text css are both float right and are positioned in FIFO order

					if (onTheFly)
					{
						newLi.append( $("<span class='PoCaRangeOTF' />").html("<b>Finalize</b>") );
					}
					
					playlist.append(newLi);
					
					var nthChildIndex = PoCaMarks.length;
					var nthChildStr = ":nth-child(" + nthChildIndex + ")";
//					scrollActivePlaylistToItem(nthChildStr);

					$("#playlistContainer").show();

					p.PrintToLog();

					newInputTimeA = newInputTimeB = convertFromSeconds(controls.getTimeB());
					
					var blankTime = "";
					
					document.getElementById("inputPoCaDelay").value = newInputPoCaDelay = "0";
					document.getElementById("inputPoCaTitle").value = newInputPoCaTitle = "";
					document.getElementById("inputPoCaNotes").value = newInputPoCaNotes = "";
				};
				InitBehaviourB.prototype.setA = function(timeAInSeconds) {
					alert("called legacy func: InitBehaviourB.prototype.setA");
					var timeAHHMMSS = convertFromSeconds(timeAInSeconds);
					newInputTimeA = timeAHHMMSS;
				};
				InitBehaviourB.prototype.setB = function(timeBInSeconds) {
					alert("called legacy func: InitBehaviourB.prototype.setB");
					var timeBHHMMSS = convertFromSeconds(timeBInSeconds);
					newInputTimeB = timeBHHMMSS;
				};

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function InitBehaviour(mode) {
					this.name = "Behaviour";
					this.behaviour = (mode==0) ? new InitBehaviourA() : new InitBehaviourB();
				}
				InitBehaviour.prototype.CreatePoCaMark = function(media) {
					this.behaviour.CreatePoCaMark(media);
				};
				InitBehaviour.prototype.CreatePoCaRange = function(media, onTheFly) {
					this.behaviour.CreatePoCaRange(media, onTheFly);
				};
				InitBehaviour.prototype.setA = function(timeAInSeconds) {
					this.behaviour.setA(timeAInSeconds);
				};
				InitBehaviour.prototype.setB = function(timeBInSeconds) {
					this.behaviour.setB(timeBInSeconds);
				};

				var behaviour = new InitBehaviour(1);

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________

				function stringStartsWith(source, search)
				{
					return source.lastIndexOf(search, 0) === 0;
				}

				function searchPodcastURLs(url)
				{
					var arr = null; 
					
					if (stringStartsWith(url, "file") || !stringStartsWith(url, "http"))
					{
						console.log("searchPodcastURLs prematurely ended");
						return arr;
					}

					var podcastSites = $("#PodcastSite option");
					var numSites = podcastSites.length;
					
					for (var i=0; i< numSites; ++i)
					{
						var podcastsComboBoxId = "#Site" + i + "Podcasts";
						var podcastList = $(podcastsComboBoxId + " option");

						$.each(podcastList,function(idx, item){
							var podcastURL = $(item).attr('value');
							
							if (url == podcastURL)
							{
								var podcastIndex = idx;
								var siteIndex = $(item).parent().attr('value');
		
								arr = [siteIndex, podcastIndex];
								return false; //breaks the loop (currently in an inner function)
							}
							
						});

						if (arr)
						{
							return arr;
						}
					}
					return arr;
				}

				
				function setComboBoxesFromPodcastURL(url)
				{
					var comboBoxIndices = searchPodcastURLs(url);
					if (comboBoxIndices)
					{
						var siteIndex = comboBoxIndices[0];
						var podcastIndex = comboBoxIndices[1];
						
						$("#PodcastSite").val(siteIndex).change();

						var podcastsComboBoxId = "#Site" + siteIndex + "Podcasts";
						$(podcastsComboBoxId).prop('selectedIndex', podcastIndex);
						
						$('#setUrl0').click();
						
						return true;
					}

					$("#PodcastSite").val(0).change();
					
					return false;
				}

//import/export
				$('#exportToFileCheckBox').change(function() {
					if(this.checked) {
						$("#filenameToSaveAs").removeClass("disabledText");
						$("#inputFileNameToSaveAs").prop('disabled',false);
					}
					else{
						$("#filenameToSaveAs").addClass("disabledText");
						$("#inputFileNameToSaveAs").prop('disabled',true);
					}
				});
				
				
				function clearExportedURL()
				{
					document.getElementById("inputTinyURL").value = "";
				}
				
				jQuery('#savePoCaDataBtn').click(function() {

					$("#exportedURL").hide();
					document.getElementById("inputTinyURL").value = "";
					
					var fileNameToSaveAs;

					if ($("#exportToFileCheckBox").prop('checked')) {
						
						fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;
						
						if ($.trim(fileNameToSaveAs).length === 0)
						{
							alert("Please enter a valid filename");
							return;
						}
					}

					//get theme ordering from UI tab ordering
					//https://stackoverflow.com/questions/2754021/jquery-get-a-list-of-values-of-an-attribute-from-elements-of-a-class
					var themeIdList = $("#tab .tablinks").map(function(){return  $("#" + $(this).data("tabname")).attr("themeid"); }).get()
					var themesArr = new Array();
					$.each(themeIdList,function(idx, item){
						themesArr.push(themeMap.get(item));
					});
					
					var tempPoCaMarks = [];

					for (i=0; i < themesArr.length; ++i)
					{
						//append array to tempPoCaMarks array. NB: A theme's PoCaMark ordering correctly matches it's visual item ordering
						tempPoCaMarks.push.apply(tempPoCaMarks, themesArr[i].PoCaMarks);
					}

					//if all pocamarks are sharing the same url, minimise output data by shortening each pocamark by omitting its url
					if (sharedUrl) {
						for (i=0; i < tempPoCaMarks.length; ++i)
						{
							tempPoCaMarks[i].url = "";
						}
					}

					var PoCaDataObj = Object.create(PoCaData.prototype);
					PoCaDataObj.FileFormatVersion = fileFormatVersion;
					PoCaDataObj.Author = author;
					PoCaDataObj.DateCreated = dateCreated;
					PoCaDataObj.DateModified = Date().toString();
					PoCaDataObj.SharedUrl = sharedUrl;
					PoCaDataObj.PoCaThemes = themesArr;
					PoCaDataObj.PoCaMarks = tempPoCaMarks;

					var textToSave = JSON.stringify(PoCaDataObj);
					
					console.log(textToSave);
					//generate lzma compressed PoCaMark data for URL query string
					//document.getElementById("exportPoCaDataToSaveBase64").value = btoa(textToSave); //base64 (uncompressed) load test
					try {
						const lib = JsonUrl("lzma");
						lib.compress(textToSave).then(output => {
							var newURL = window.location.protocol + "//" + window.location.host + window.location.pathname + "?data=" + output
							document.getElementById("inputTinyURL").value = newURL;
						});
					} catch (err) {
						document.getElementById("inputTinyURL").value = `Unable to compress. Reason: ${err}`;
					}
					
					$("#exportedURL").show();
					
					
					if ($("#exportToFileCheckBox").prop('checked') == false) {
						return;
					}
					
					var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
					var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
				 
					var downloadLink = document.createElement("a");
					downloadLink.download = fileNameToSaveAs;
					downloadLink.innerHTML = "Download File";
					downloadLink.href = textToSaveAsURL;
					downloadLink.onclick = DestroyClickedElement;
					downloadLink.style.display = "none";
					document.body.appendChild(downloadLink);
				 
					downloadLink.click();
				});

				function DestroyClickedElement(event)
				{
					document.body.removeChild(event.target);
				}


				function LoadPoCaData(textFromFileLoaded)
				{
					loadingFromPoCaFile = true;
					playerLoadedData = false;

					var json2 = textFromFileLoaded;
					
					console.log(json2);
					var PoCaDataObj = PoCaData.FromJson(json2);

					resetTabsOnLoad();

					fileFormatVersion = PoCaDataObj.FileFormatVersion;
					author = PoCaDataObj.Author;
					dateCreated = PoCaDataObj.DateCreated;
					dateModified = PoCaDataObj.DateModified;
					sharedUrl = PoCaDataObj.SharedUrl;

					if (!sharedUrl) {
						AllPoCaItemsHaveSharedUrl = false;
					}
					
					var PoCaThemes2 = PoCaDataObj.PoCaThemes;
					var PoCaMarks2 = PoCaDataObj.PoCaMarks;
					for (i=0; i < PoCaThemes2.length; ++i)
					{
						PoCaThemes2[i].PrintToLog();
						addTheme(PoCaThemes2[i]); // creates UI tab, theme context, empty playlist
					}

					var firstUrl = "";
					if (sharedUrl) {
						firstUrl = sharedUrl;
					}
					else if (PoCaMarks2.length > 0) {
						firstUrl = PoCaMarks2[0].url;
					}

					var videoMediaType = false; //default to audio player
					if (firstUrl) {

						videoMediaType = ( stringStartsWith(firstUrl, "https://www.youtube.") ||
										   stringStartsWith(firstUrl, "http://www.youtube.")  ||
										   stringStartsWith(firstUrl, "www.youtube.")
										 );
					}
						
					console.log("PoCaMarks file videoMediaType: " + videoMediaType);
					
					if (videoMediaType)
					{
						createVideoPlayer();
					}
					else
					{
						createAudioPlayer();
					}

					InitMediaPlayer(); //must be called before switchContextOnDeleteTab!!!
					$("#MediaModePanel").hide();
						
					//set first theme tab and it's playlist to active 
					playlistItemSelected = false;
					showingPoCaRangeButton = false;
					currentThemeID = "onload";
					switchContextOnDeleteTab("onload"); //must create and initialise media player before calling this!


					playlistID = 0;
					totalSnippetSecondsAtLoadTime = 0;
					for (i=0; i < PoCaMarks2.length; ++i)
					{
						var playlist = $("#tabs-" + PoCaMarks2[i].themeId + " .playlist");
						var themePoCaMarks = themeMap.get(PoCaMarks2[i].themeId).PoCaMarks;
						var themePlaylistMap = themeMap.get(PoCaMarks2[i].themeId).playlistMap;
						
						//each pocamark must always maintain it's url even if shared in case later the shared url is invalidated due to a multiple source urls for the collection
						if (sharedUrl && !PoCaMarks2[i].url) {
							PoCaMarks2[i].url = sharedUrl;
						}
						PoCaMarks2[i].PrintToLog();
						themePoCaMarks.push(PoCaMarks2[i]);
																
						playlistID++;
						themePlaylistMap.set(playlistID.toString(), PoCaMarks2[i]);
						
						totalSnippetSecondsAtLoadTime += ((+PoCaMarks2[i].stop) - (+PoCaMarks2[i].start));
						var tA = convertFromSeconds(PoCaMarks2[i].start);
						var tB = convertFromSeconds(PoCaMarks2[i].stop);
						
						var onTheFly = PoCaMarks2[i].type == "PoCaRangeOTF";

						var newLi = $("<li class='list-group-item " + (onTheFly ? "onTheFly" : "") + "' />")
									.val(playlistID)
									.attr('itemId', themePoCaMarks.length -1)
									.append($("<i class='fa fa-arrows grabbable' aria-hidden='true'/>").html("&nbsp;&nbsp;&nbsp;"))
									.append($("<span class='timerangetext' />").html(tA + " - " + tB))
									.append($("<span class='ui-icon ui-icon-closethick'/>"));//remove icon and Finalize text css are both float right and are positioned in FIFO order

						if (onTheFly)
						{
							newLi.append( $("<span class='PoCaRangeOTF' />").html("<b>Finalize</b>") );
						}
					
						playlist.append(newLi);
					}


					$("#playlistContainer").show();

					if (firstUrl)
					{
						var foundUrl = false;

						if (videoMediaType)
						{
							$("#SelectPodcast").hide();
						}
						else
						{
							foundUrl = setComboBoxesFromPodcastURL(firstUrl);
						}

						if (!foundUrl)
						{
							$("#urlInput")[0].value = firstUrl;
							$('#setUrl').click();
						}
					}

					currentPoCaMarkIndex = 0;
					$("#PoCaMode").prop('checked', false).change();

					$("#importFilePanel").hide();
					$("#PoCaFilesPanel").hide();
					
					loadingFromPoCaFile = false;

					$("#MediaPanel").show();
				}
				
				var loadingFromPoCaFile = false;
				jQuery('#loadPoCaDataBtn').click(function() {
					var fileToLoad = document.getElementById("fileToLoad").files[0];
					var fileReader = new FileReader();
					fileReader.onload = function(fileLoadedEvent) 
					{
						//https://github.com/masotime/json-url
						//http://jsbin.com/cayuhox
						var textFromFileLoaded = fileLoadedEvent.target.result;

						LoadPoCaData(textFromFileLoaded);

					};
					fileReader.readAsText(fileToLoad, "UTF-8");
				});

				
				$('#expandImportFileOptions').click(function() {
					var c = '+';
					if ($("#expandImportFileOptions span:nth-child(1)").html()[0] == '+') c = '-';
					$("#expandImportFileOptions span:nth-child(1)").html(c);

					$('#contentImportFileOptions').slideToggle('fast');				
				});

				$('#expandExportFileOptions').click(function() {
					var c = '+';
					if ($("#expandExportFileOptions span:nth-child(1)").html()[0] == '+') c = '-';
					$("#expandExportFileOptions span:nth-child(1)").html(c);

					$('#contentExportFileOptions').slideToggle('fast');				
				});

//____________________________________________________________________________________________________
//____________________________________________________________________________________________________
				var mediaPlayer = null;
				function InitMediaPlayer() {
				

				
				$('#player').mediaelementplayer({
					alwaysShowControls: true,
					features: ['playpause','volume','loop','current','duration','progress'],
					alwaysShowHours: true,
					audioVolume: 'horizontal',
					audioWidth: 600,

					success: function(media, node, player) {
						mediaPlayer = media;
						
						InitControls(mediaPlayer);
						controls.setCallbackSetA(setA);
						controls.setCallbackSetB(setB);
						
						var sliderHandle = $( "#slider-handle" );

						$('#slider').slider({
							range: false,
							min: 0,
							max: 100,
							orientation: "horizontal",
							values: [0],
							create: function() {
								sliderHandle.text( convertFromSeconds( $( this ).slider( "value" ) ) );
							},

							slide: function(event, ui) {
								var timeInSeconds = ui.value;
								sliderHandle.text( convertFromSeconds(timeInSeconds) );
								
								media.setCurrentTime(timeInSeconds);

							}
						});


						jQuery('.bm3').click(function() {
							media.setCurrentTime($("#timeInput")[0].value);
						});

						jQuery('.cbm').click(function() {
							var timeInSeconds = media.getCurrentTime();
							$("#timeOutput").val(timeInSeconds);
							$("#timeOutput2").val(convertFromSeconds(timeInSeconds));
						});


						var mcTimeThreshold = 300; //220-370
						var firstMCTime = 0;
						var lastMCTime = 0;
						var multiClickCount = 0;

						function createOnTheFlyPoCaRange(multiClickCount)
						{
							var endTime = firstMCTime;
							var startTime = endTime;
							
							switch (multiClickCount)
							{
								case 1: startTime -= 60;   break;
								case 2: startTime -= 60*2; break;
								case 3: startTime -= 60*3; break;
								case 4: startTime -= 60*4; break;
								case 5: startTime -= 60*5; break;
								default:startTime -= 60*6; break;
							}
							
							//clamp the start time!
							startTime =  (startTime < 0) ? 0 : startTime;


							controls.setTimes(startTime, endTime);
							
							document.getElementById("inputPoCaDelay").value = 0;
							document.getElementById("inputPoCaTitle").value = "";
							document.getElementById("inputPoCaNotes").value = "";

							var onTheFly = true;
							behaviour.CreatePoCaRange(media, onTheFly);
						}
												
						jQuery('#multi-click').click(function() {
						
							if (currentPoCaMode == 1) return; //shouldn't work in play mode
						
							++multiClickCount;
							lastMCTime = Date.now();
							
							if (multiClickCount == 1)
							{
								firstMCTime = media.getCurrentTime();
							}
						
							setTimeout(function () {
								
								var time2 = Date.now();

								if (time2 > lastMCTime + mcTimeThreshold)
								{
									console.log("multiClickCount: " + multiClickCount);
									createOnTheFlyPoCaRange(multiClickCount);

									lastMCTime = time2;
									multiClickCount = 0;
								}
							}, mcTimeThreshold + 50);

						});



						jQuery('#createPoCaMark').click(function() {
							behaviour.CreatePoCaMark(media);
						});

						jQuery('#createPoCaRange').click(function() {
						
								clearExportedURL();

							var onTheFly = false;
							behaviour.CreatePoCaRange(media, onTheFly);
						});

						jQuery("#PodcastSite").change(function () {
							//First hide all podcast lists
							$(".selectric-wrapper").hide();

							//then show the selected site's podcast list
							var selectedSite = $("#PodcastSite").find('option:selected').index();
							if (selectedSite == 0)
							{
								document.getElementById("setUrl0").style.display = 'none';
							}
							else
							{
								document.getElementById("setUrl0").style.display = '';
							}
							
							console.log("selectedSite: " + selectedSite);
							var podcastsComboBoxId = "Site" + selectedSite + "Podcasts";

							$("#" + podcastsComboBoxId).prop('selectedIndex', 0).selectric('refresh');
							$("#" + podcastsComboBoxId).parent().parent().show();
						});
						
						
						function checkAndSetSharedUrlFromUI(url) {
							if (AllPoCaItemsHaveSharedUrl) {
								if (!sharedUrl) { //initial page loaded case
									sharedUrl = url; //JOT! need to perform some logic here to set or unset depending on if pocamarks (for all themes) exist and whether they have the same URL or not!
								}
								else if (sharedUrl != url) {
									sharedUrl = "";
									AllPoCaItemsHaveSharedUrl = false;
								}
							}
						}


						//setUrl0
						jQuery('#setUrl0').click(function() {
							console.log("loadingFromPoCaFile: " + loadingFromPoCaFile);

							clearExportedURL();
							var selectedSite = $("#PodcastSite").find('option:selected').index();
							console.log("selectedSite: " + selectedSite);

							var mp3Url = document.getElementById("Site" + selectedSite + "Podcasts").value
							console.log("mp3Url: " + mp3Url);
							$("#urlInput")[0].value = mp3Url;

							checkAndSetSharedUrlFromUI(mp3Url);

							media.setSrc(mp3Url);
							media.load();
						});


						//setUrl
						jQuery('#setUrl').click(function() {
							console.log("loadingFromPoCaFile: " + loadingFromPoCaFile);
							
							clearExportedURL();
							if (!loadingFromPoCaFile)
							{
								var foundUrl = setComboBoxesFromPodcastURL($("#urlInput")[0].value);	
								if (foundUrl)
									return;		
							}
							//IF loading from poca file Or
							//IF NOT loading from poca file AND url not found
							var url = $("#urlInput")[0].value;
							
							checkAndSetSharedUrlFromUI(url);

							media.setSrc(url);
							media.load();
						});

						var lastNewInputPoCaDelay = "";
						var lastInputPoCaDelay = "";

						var lastNewInputPoCaTitle = "";
						var lastInputPoCaTitle = "";

						var lastNewInputPoCaNotes = "";
						var lastInputPoCaNotes = "";

						
						function playlistGainedFocus()
						{
							console.log("playlistGainedFocus");
							var timeAInSeconds = PoCaMarks[currentPoCaMarkIndex].start;
							var timeBInSeconds = PoCaMarks[currentPoCaMarkIndex].stop;
							controls.setTimes(timeAInSeconds, timeBInSeconds);

							lastInputPoCaDelay = document.getElementById("inputPoCaDelay").value = PoCaMarks[currentPoCaMarkIndex].delay;
							lastInputPoCaTitle = document.getElementById("inputPoCaTitle").value = PoCaMarks[currentPoCaMarkIndex].title;
							lastInputPoCaNotes = document.getElementById("inputPoCaNotes").value = PoCaMarks[currentPoCaMarkIndex].notes;
						}

						function resumePlayBack(oldIndex)
						{
							pausedOnStopPoint = false;
							var startTime = 0;
							
							if (PoCaMarks.length > oldIndex) {
								var nthChildIndex = oldIndex;
								nthChildIndex++;

								console.log("nthChildIndex="+nthChildIndex);
								var nthChildStr = ":nth-child(" + nthChildIndex + ")";
								$('.active-playlist li' + nthChildStr).removeClass('currentlyPlaying');
								console.log("removing class, nstr="+nthChildStr);
							}
							
							if (PoCaMarks.length > currentPoCaMarkIndex) {
								startTime = PoCaMarks[currentPoCaMarkIndex].start;

								var nthChildIndex = currentPoCaMarkIndex;
								nthChildIndex++;

								console.log("nthChildIndex="+nthChildIndex);
								var nthChildStr = ":nth-child(" + nthChildIndex + ")";
								console.log("adding class, nstr="+nthChildStr);
								$('.active-playlist li' + nthChildStr).addClass('currentlyPlaying');

								scrollActivePlaylistToItem(nthChildStr);

								currentplaylistID = $('.active-playlist li' + nthChildStr).attr('value');
								console.log("currentplaylistID="+currentplaylistID);
								
								playlistGainedFocus();
							}
							
							$('#slider').slider('values', 0, startTime);
							sliderHandle.text( convertFromSeconds(startTime) );
							var start = Math.trunc(startTime);
							var end = Math.trunc(PoCaMarks[currentPoCaMarkIndex].stop);
							$("#slider").slider('option', {min: start, max: end});
							
							media.setCurrentTime(startTime);
							
							if (currentPoCaMode == 0) //if in edit mode
							{
								return;
							}
							media.play();
						} //resumePlayBack

						jQuery("#inputPoCaDelay").on('change keyup paste mouseup', function () {
						
							if (playlistItemSelected)
							{
								if ($(this).val() != lastInputPoCaDelay)
								{
									lastInputPoCaDelay = $(this).val();
									console.log('The delay text box really changed this time');
									PoCaMarks[currentPoCaMarkIndex].delay = $(this).val();
								}
							}
							else
							{
								if ($(this).val() != lastNewInputPoCaDelay)
								{
									lastNewInputPoCaDelay = newInputPoCaDelay = $(this).val();
									console.log('The delay text box really changed this time');
								}
							}
	
						});

						jQuery("#inputPoCaTitle").on('change keyup paste mouseup', function () {
						
							if (playlistItemSelected)
							{
								if ($(this).val() != lastInputPoCaTitle)
								{
									lastInputPoCaTitle = $(this).val();
									console.log('The title text box really changed this time');
									PoCaMarks[currentPoCaMarkIndex].title = $(this).val();
								}
							}
							else
							{
								if ($(this).val() != lastNewInputPoCaTitle)
								{
									lastNewInputPoCaTitle = newInputPoCaTitle = $(this).val();
									console.log('The title text box really changed this time');
								}
							}
	
						});

						jQuery("#inputPoCaNotes").on('change keyup paste mouseup', function () {
						
							if (playlistItemSelected)
							{
								if ($(this).val() != lastInputPoCaNotes)
								{
									lastInputPoCaNotes = $(this).val();
									console.log('The notes text box really changed this time');
									PoCaMarks[currentPoCaMarkIndex].notes = $(this).val();
								}
							}
							else
							{
								if ($(this).val() != lastNewInputPoCaNotes)
								{
									lastNewInputPoCaNotes = newInputPoCaNotes = $(this).val();
									console.log('The notes text box really changed this time');
								}
							}
	
						});

						function updatePlaylistItemTimeText()
						{
							var nthChildIndex = currentPoCaMarkIndex;
							nthChildIndex++;

							console.log("nthChildIndex="+nthChildIndex);
							var nthChildStr = ":nth-child(" + nthChildIndex + ")";
							console.log("updating playlist item time text, nstr="+nthChildStr);

							var tA = convertFromSeconds(PoCaMarks[currentPoCaMarkIndex].start);
							var tB = convertFromSeconds(PoCaMarks[currentPoCaMarkIndex].stop);
							$('.active-playlist li' + nthChildStr + ' .timerangetext').html(tA + " - " + tB);
						}

						function setA(timeAInSeconds) {
							if (currentPoCaMode == 1) return; //shouldn't work in play mode

							if (playlistItemSelected)
							{
								PoCaMarks[currentPoCaMarkIndex].start = timeAInSeconds;
								updatePlaylistItemTimeText();
							}
							else
							{
								newInputTimeA = convertFromSeconds(timeAInSeconds);
								console.log("TimeA changed: " + newInputTimeA);
							}

						}
						function setB(timeBInSeconds) {
							if (currentPoCaMode == 1) return; //shouldn't work in play mode

							if (playlistItemSelected)
							{
								PoCaMarks[currentPoCaMarkIndex].stop = timeBInSeconds;
								updatePlaylistItemTimeText();
							}
							else
							{
								newInputTimeB = convertFromSeconds(timeBInSeconds);
								console.log("TimeB changed: " + newInputTimeB);
							}
						}

						var playerLoadedData = false;
						function hideTimeRail() {
							if (playerLoadedData) //when loading from url/file - we immediately switch to play mode before data is loaded. time bar still needs to be visible to adjust initial slider positions
							{
								$('.mejs__container .mejs__time-rail').css('display','none'); //prevent time changes via progress/seek bar while playing PoCa Marks
							}
						}

						function showTimeRail() {
							$('.mejs__container .mejs__time-rail').css('display','block'); //allow time changes via progress/seek bar in edit mode
						}

						jQuery("#PoCaMode").change(function () {
							if ($("#PoCaMode")[0].checked) {  //edit mode
								currentPoCaMode = 0;

								media.pause();
								showTimeRail();
								
								$(".editcontrols").prop("readonly", false);
								
								$("#multi-click").show();
								$(".PoCaRangeOTF").show();

								playlistUI.enable();
								$("#createButtonsDiv").show();
								controls.enable();
								$("#exportFilePanel").show();
							}
							else {													//play mode

								currentPoCaMode = 1;
								var oldIndex = currentPoCaMarkIndex;
								currentPoCaMarkIndex = 0;
								resumePlayBack(oldIndex);

								hideTimeRail();
								
								$(".editcontrols").prop("readonly", true);
								$(".editcontrolslabel").hide();
								$("#multi-click").hide();
								$(".PoCaRangeOTF").hide();
								
								controls.disable();
								$("#createButtonsDiv").hide();
								playlistUI.disable();

								$("#exportFilePanel").hide();
							}
						});
						

						$("#tabcontents").on("click touchstart", ".active-playlist .list-group-item", function(e) {

							var tempPlaylistMapID = $(this).attr('value');

							console.log("playlist item clicked  " + tempPlaylistMapID);

							var SelectedPoCaIndex = $(this).attr('itemId');
							var oldIndex = currentPoCaMarkIndex;
							currentPoCaMarkIndex = SelectedPoCaIndex;
							resumePlayBack(oldIndex);
						});	


						$("#tabcontents").on("click touchstart", ".active-playlist .list-group-item .PoCaRangeOTF", function(e) {
							var li = $(this).parent();
							var OtfPoCaIndex = li.attr('itemId');
							PoCaMarks[OtfPoCaIndex].type = "PoCaRange";
							li.removeClass("onTheFly");

							$(this).remove();
							e.stopPropagation(); //stops the bubbling of an event to parent elements. (Prevents li selection)
						});	

						//clicking a tab header makes its playlist active
						function onTabButtonClicked(tabPanelId) {
							tabPanelId = "#" + tabPanelId;
							
							console.log("tabPanelId: " + tabPanelId);
							var nextThemeId = $(tabPanelId).attr("themeId");
							console.log("currentThemeID: " + currentThemeID);
							console.log("nextThemeId: " + nextThemeId);
							if (nextThemeId == currentThemeID)
							{
								console.log("No need to switch theme context");
								return;
							}
							
							media.pause();
							
							var tempPlaylistItemSelected = playlistItemSelected;
							console.log("tempPlaylistItemSelected: " + tempPlaylistItemSelected);

							playlistItemLostFocus();
							
							if (currentThemeID != "onload")
							{
								var currentTheme = themeMap.get(currentThemeID.toString());
								currentTheme.currentplaylistID = currentplaylistID;
								currentTheme.currentPoCaMarkIndex = currentPoCaMarkIndex;
								currentTheme.playlistItemSelected = tempPlaylistItemSelected;
								currentTheme.showingPoCaRangeButton = showingPoCaRangeButton;
								currentTheme.playlistMap = playlistMap;
								currentTheme.PoCaMarks = PoCaMarks;
							}

							
							var nextTheme = themeMap.get(nextThemeId.toString());
							console.log("nextTheme: " + nextTheme);
							currentplaylistID = nextTheme.currentplaylistID;
							currentPoCaMarkIndex = nextTheme.currentPoCaMarkIndex;
							playlistItemSelected = nextTheme.playlistItemSelected;
							showingPoCaRangeButton = nextTheme.showingPoCaRangeButton;
							playlistMap = nextTheme.playlistMap;
							PoCaMarks = nextTheme.PoCaMarks;
							currentThemeID = nextThemeId;

							//playlistGainedFocus operates on the active playlist, so deal with the first
							$("#tabcontents .active-playlist").removeClass("active-playlist");
							$(tabPanelId + " .playlist").addClass("active-playlist");

							console.log("after switch, playlistItemSelected: " + playlistItemSelected);

							if (playlistItemSelected)
							{
								$(".editcontrolslabel").hide();
								$("#createPoCaRange").hide();
								
								playlistGainedFocus();
							}
							else
							{
								$(".editcontrolslabel").show();

								if (showingPoCaRangeButton)
								{
									$("#createPoCaRange").show();
								}
							}
							
						}
						playlistUI.setCallbackTabButtons(onTabButtonClicked);


						function playlistItemLostFocus()
						{
							playlistItemSelected = false;

							$(".editcontrolslabel").show();
							
							$("#createPoCaRange").show();

							controls.setTimes(convertToSeconds(newInputTimeA), convertToSeconds(newInputTimeB));

							document.getElementById("inputPoCaDelay").value = newInputPoCaDelay;
							document.getElementById("inputPoCaTitle").value = newInputPoCaTitle;
							document.getElementById("inputPoCaNotes").value = newInputPoCaNotes;
						}
						
						window.addEventListener('mousedown', function(e){   
							if (document.getElementsByClassName('active-playlist')[0].contains(e.target)){
								//playlist clicked
								console.log("playlist clicked focus: ");

								playlistItemSelected = true;
								
								$(".editcontrolslabel").hide();
								$("#createPoCaRange").hide();
								
								playlistGainedFocus();
							}
							else{
								//clicked outside of playlist
							
								if (!( (currentPoCaMode == 1 && $(e.target).parents('.mejs__container').length ) || //clicking the player looses playlist focus only in edit mode
								     $(e.target).hasClass('editcontrols') || $(e.target).closest('.editcontrols').length ||
									 $(e.target).hasClass('tablinks') ))
								{
									console.log("playlist lost focus: " + e.srcElement);
									playlistItemLostFocus();
								}
								
							}
						});
  
						media.addEventListener('pause', function (e) {
							paused = true;
						});

						media.addEventListener('play', function (e) {
							paused = false;
						});

						media.addEventListener('seeking', function (e) {
							controls.onSeeking();
						});

						media.addEventListener('seeked', function (e) {
							controls.onSeeked();
						});
					
						var _lastTime = 0;
						media.addEventListener('playing', function (e) {
							interval = setInterval(function () {
								var currentTime = media.currentTime;

								if (!isNaN(currentTime) && currentTime > 0) {

									if (currentPoCaMode == 1) //play mode
									{
										if (pausedOnStopPoint)
										{
											
											var elapsed = (new Date() - pausedAtTime) / 1000;
											if (elapsed >= PoCaMarks[currentPoCaMarkIndex].delay) {
											
												var oldIndex = currentPoCaMarkIndex;
												currentPoCaMarkIndex++;

												//loop around PoCaMarks
												if (currentPoCaMarkIndex >= PoCaMarks.length) {
													currentPoCaMarkIndex = 0;
												}

												resumePlayBack(oldIndex);
											}
										}
										else { //playing
											
											if (PoCaMarks.length > currentPoCaMarkIndex)
											{
												var cueTime = PoCaMarks[currentPoCaMarkIndex].stop;
												if (cueTime >= _lastTime) {

													sliderHandle.text( convertFromSeconds(currentTime) );
													$('#slider').slider('values', 0, currentTime);
													
													if (cueTime <= currentTime) {
														media.pause();
														pausedAtTime = new Date();
														pausedOnStopPoint = true;
													}
												}
											}
										}
									}
									else if (currentPoCaMode == 0) //edit mode
									{
										if (!paused)
										{
											controls.onPlayTick(currentTime, _lastTime);									
										}
									}

									_lastTime = currentTime;
								}
							}, 50);

						}, false);

						media.addEventListener('loadeddata', function () {
							controls.loadedData();

							if (totalSnippetSecondsAtLoadTime != undefined)
							{
								//calculate time stats
								var dur = media.getDuration();
								console.log("\nMedia duration: " + dur + "s");
								console.log("Snippets duration: " + totalSnippetSecondsAtLoadTime + "s");
								console.log("Listening time: " + (totalSnippetSecondsAtLoadTime / dur * 100.0).toFixed(2) + "%");
							}

							if (!loadingFromPoCaFile){
								$("#createButtonsDiv").show();

								playerLoadedData = true;
								if (currentPoCaMode == 1) {
									hideTimeRail();
								}
							}
						});

						controls.refreshAllSlidersUI();
						
					} //success: func...
				});
				}
				
				jQuery("#start").click(function () {

					if ($("#MediaType")[0].checked == false) {  //audio
						if (mediaPlayer != null) {
							mediaPlayer.pause();
							mediaPlayer.setSrc("");
							mediaPlayer.load();
							mediaPlayer.remove();
							mediaPlayer = null;
						}
						createAudioPlayer();
						InitMediaPlayer();
					}
					else {														 //video
						if (mediaPlayer != null) {
							mediaPlayer.pause();
							mediaPlayer.setSrc("");
							mediaPlayer.load();
							mediaPlayer.remove();
							mediaPlayer = null;
						}
						createVideoPlayer();
						InitMediaPlayer();
						
						$("#SelectPodcast").hide();
					}
					
					$("#MediaModePanel").hide();
					$("#importFilePanel").hide();
					$("#PoCaFilesPanel").hide();
					

					initMainTabOnPageLoad();
					
					$("#MediaPanel").show();

				});


				function removePocaMarkFromLastTheme(lastThemeId, playlistMapIDToRemove)
				{
					var lt = themeMap.get(lastThemeId.toString());

					var markToMove = lt.playlistMap.get(playlistMapIDToRemove.toString());
					lt.playlistMap.delete(playlistMapIDToRemove.toString());

					if (playlistMapIDToRemove == lt.currentplaylistID)
					{
						lt.currentPoCaMarkIndex = 0;
						console.log("reset lt.currentPoCaMarkIndex="+lt.currentPoCaMarkIndex);
					}

					var liList = $("#tabcontents .tabcontent[themeid=" + lastThemeId + "] .playlist li");
					if (liList.length == 0) lt.playlistItemSelected = false;
					
					lt.PoCaMarks.length = 0; //clear the vector
					
					$.each(liList,function(idx, item){
						var tempPlaylistMapID = $(item).attr('value');

						var mark = lt.playlistMap.get(tempPlaylistMapID); //should check with 'has' func first!!!
						lt.PoCaMarks.push(mark);
						
						var itemId = lt.PoCaMarks.length -1;
						$(item).attr('itemId', itemId);
						
						if (tempPlaylistMapID == lt.currentplaylistID)
						{
							lt.currentPoCaMarkIndex = itemId;
							console.log("lt.currentPoCaMarkIndex="+lt.currentPoCaMarkIndex);
						}
					});
					
					return markToMove;
				}


				function PlaylistModified()
				{
					var liList = $(".active-playlist li");
					if (liList.length == 0) playlistItemSelected = false;

					PoCaMarks.length = 0; //clear the vector
					
					$.each(liList,function(idx, item){
						var tempPlaylistMapID = $(item).attr('value');

						var mark = playlistMap.get(tempPlaylistMapID); //should check with 'has' func first!!!

						PoCaMarks.push(mark);
						
						var itemId = PoCaMarks.length -1;
						$(item).attr('itemId', itemId);
						
						if (tempPlaylistMapID == currentplaylistID)
						{
							currentPoCaMarkIndex = itemId;
							console.log("currentPoCaMarkIndex="+currentPoCaMarkIndex);
						}
					});
				}

				$("#tabcontents").on("click touchstart", ".active-playlist .list-group-item .ui-icon-closethick", function(e) {
					var liElem = $(this).parent();
					var tempPlaylistMapID = liElem.val();
					console.log("tempPlaylistMapID: "+tempPlaylistMapID);
					playlistMap.delete(tempPlaylistMapID);

					liElem.remove();
					
					var liList = document.getElementsByClassName('active-playlist')[0].getElementsByTagName("li");
					
					PlaylistModified();

					e.stopPropagation(); //stops the bubbling of an event to parent elements. (Prevents li selection)
				});

				function onPlaylistItemMoved(movedToAnotherPlaylist, item, fromElem, oldIndex) {

					if (movedToAnotherPlaylist) {	//NB theme has already switched. so remove pocamark from last theme and insert it into current theme
						var lastThemeId = $(fromElem).parent().attr("themeId");
						console.log("old themeId, index: " + lastThemeId + ", " + oldIndex);

						var playlistMapIDToRemove = $(item).val();
						console.log("playlistMapIDToRemove:"+playlistMapIDToRemove)
						var markToMove = removePocaMarkFromLastTheme(lastThemeId, playlistMapIDToRemove);

						console.log("current theme Id: " + currentThemeID);
						console.log("current playlistMap size: " + playlistMap.size);

						var nextFreePlaylistMapID;
						for(var i = 1; i <= playlistMap.size +1; ++i)
						{
							if (!playlistMap.has(i.toString()))
							{
								console.log("nextFreePlaylistMapId: "+ i);
								nextFreePlaylistMapID = i.toString();
							}
						}
						playlistMap.set(nextFreePlaylistMapID.toString(), markToMove);
						$(item).val(nextFreePlaylistMapID);
						$(item).removeClass("currentlyPlaying");
					}
					
					PlaylistModified();
					
				}
				playlistUI.setCallbackPlaylistItemMoved(onPlaylistItemMoved);

				InitialiseSortablePlaylist("tabs-1", ".playlist");


				//load PoCaMark data from lzma compressed URL query string - if it exists
				var url_string = window.location.href;
				var url = new URL(url_string);
				var urlData = url.searchParams.get("data");
				var urlFile = url.searchParams.get("file");
				
				if (urlData != null && urlData != "")
				{
					//var textFromFileLoaded = atob(textToSave); //base64 (uncompressed) load test
					try {
						const lib = JsonUrl("lzma");
						lib.decompress(urlData).then(textFromFileLoaded => {
							LoadPoCaData(textFromFileLoaded);
						})
					} catch (err) {
						console.log("Unable to decompress. Reason: ${err}");
					}
				}
				else if (urlFile != null && urlFile != "")
				{
					function fetchPoCaFile(url, onLoadCallback) {
						const req = new XMLHttpRequest();    
						req.onload = () => {
							onLoadCallback(req.responseText);
						};
						req.onerror = () => {
							console.log("failed to fetch PoCaFile: " + url);
						};						
						req.open('GET', url);
						req.send();
					}
					
					fetchPoCaFile("./PoCaFiles/" + urlFile, function(textFromFileLoaded) {
							LoadPoCaData(textFromFileLoaded);
					});
				}
				
			}); //ready
			

		</script>


	</body>
</html>
